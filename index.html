<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>產品掃描與紀錄</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      /* AR標記樣式 */
      .ar-marker {
        position: absolute;
        pointer-events: none;
        z-index: 1000;
      }
      
      .ar-marker-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(255, 152, 0, 0.3);
        border: 4px solid #FF9800;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        animation: pulse 2s infinite;
      }
      
      .ar-marker-check {
        color: #FF9800;
        font-size: 24px;
        font-weight: bold;
        line-height: 1;
      }
      
      .ar-marker-number {
        color: #FF9800;
        font-size: 10px;
        font-weight: bold;
        margin-top: 2px;
      }
      
      @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
      }
      
      /* AR按鈕樣式 */
      #startAR, #stopAR {
        background: linear-gradient(45deg, #FF9800, #FFC107);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: bold;
        margin: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      #startAR:hover, #stopAR:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
      }
      
      #startAR:disabled, #stopAR:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
    </style>
  </head>
  <body>
    <main class="container">
      <h1>產品掃描與紀錄</h1>

      <section class="card">
        <h2>掃描 QR 碼</h2>
        <div id="preview-container">
          <video id="video" playsinline muted></video>
          <canvas id="overlay" class="overlay"></canvas>
        </div>
        <div class="row">
          <button id="startScan">開始掃描</button>
          <button id="stopScan" disabled>停止掃描</button>
          <button id="manualQR" type="button">手動輸入 QR</button>
        </div>
        <div class="row">
          <button id="startAR" type="button">啟動AR標記</button>
          <button id="stopAR" type="button" disabled>停止AR標記</button>
        </div>
        <div class="hint">若無法開啟鏡頭，請確認瀏覽器權限或改用 Safari。</div>
        
        <!-- 掃描記錄區域 -->
        <div id="scannedList" class="scanned-list">
          <p class="small">尚未掃描任何 QR 碼</p>
        </div>
        <div class="row">
          <button id="clearAllQRs" type="button" onclick="clearAllQRs()">清空所有記錄</button>
        </div>
      </section>

      <section class="card">
        <h2>輸入資料</h2>
        <form id="recordForm">
          <label>
            重工地點
            <select id="reworkType" required onchange="updateProductOptions()">
              <option value="">請選擇重工地點</option>
              <option value="廠內重工">廠內重工</option>
              <option value="廠外重工">廠外重工</option>
            </select>
          </label>

          <label>
            產品名稱
            <select id="productName" required disabled>
              <option value="">請先選擇重工地點</option>
            </select>
          </label>

          <label>
            效期
            <input type="date" id="expiryDate" required />
          </label>

          <label>
            批號（自動帶入）
            <input type="text" id="batchNumber" required readonly />
          </label>

          <label>
            QR 內容（唯一本盒）
            <input type="text" id="qrText" required readonly />
          </label>
          
          <label>
            批量模式
            <input type="checkbox" id="batchMode" onchange="toggleBatchMode()" />
            <span class="small">啟用後可一次掃描多個QR碼</span>
          </label>

          <label>
            填寫人員
            <input type="text" id="staffName" required placeholder="請輸入填寫人員姓名" />
          </label>

          <div class="row">
            <button type="submit" id="submitBtn">送出到試算表</button>
          </div>
          <div id="status" class="status"></div>
        </form>
      </section>

      <section class="card">
        <h2>Apps Script 服務設定</h2>
        <p class="small">批號會自動從「全產品批號版本」試算表查詢帶入</p>
        <div class="row">
          <label class="inline">
            Apps Script 服務網址
            <input type="url" id="gasUrl" placeholder="https://script.google.com/macros/s/xxx/exec" />
          </label>
        </div>
        <details>
          <summary>連線測試與設定</summary>
          <div class="row">
            <button id="pingService" type="button">測試連線</button>
            <span id="pingResult" class="status"></span>
          </div>
        </details>
      </section>

      <footer>
        <small>建議使用 iPhone 的 Safari 開啟此頁。資料僅於送出時寫入 Google 試算表。</small>
      </footer>
    </main>

    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <script>
      // 產品分類資料
      const PRODUCT_CATEGORIES = {
        "廠內重工": ["纖纖飲", "肽纖飲-可可", "厚焙奶茶", "水光錠", "水光面膜", "雪聚露", "婕肌零", "身體油", "護手霜", "玻尿酸", "洗髮露", "養髮液", "葉黃素EX飲", "葉黃素果凍", "正冠茶"],
        "廠外重工": ["纖飄錠", "爆纖錠", "纖酵宿", "紫纖飲", "益生菌", "固樂纖"]
      };

      // QR 掃描器實例
      let qrScanner = null;
      let scannedQRs = new Set(); // 記錄已掃描的 QR 碼，避免重複
      let batchMode = false; // 批量模式狀態

      // 全域函數：更新產品選項
      function updateProductOptions() {
        const reworkType = document.getElementById('reworkType').value;
        const productSelect = document.getElementById('productName');
        
        console.log('updateProductOptions called with reworkType:', reworkType);
        
        // 清空現有選項
        productSelect.innerHTML = '';
        
        if (!reworkType) {
          productSelect.innerHTML = '<option value="">請先選擇重工地點</option>';
          productSelect.disabled = true;
          // 清空批號
          document.getElementById('batchNumber').value = '';
          return;
        }
        
        // 啟用產品選擇
        productSelect.disabled = false;
        productSelect.innerHTML = '<option value="">請選擇產品</option>';
        
        // 加入該類別的產品
        const products = PRODUCT_CATEGORIES[reworkType] || [];
        console.log('Updating products for:', reworkType, products);
        
        products.forEach(product => {
          const option = document.createElement('option');
          option.value = product;
          option.textContent = product;
          productSelect.appendChild(option);
        });
        
        console.log('Product options updated, total options:', productSelect.options.length);
      }

      // 切換批量模式
      function toggleBatchMode() {
        batchMode = document.getElementById('batchMode').checked;
        const qrInput = document.getElementById('qrText');
        
        if (batchMode) {
          // 批量模式：顯示所有掃描的QR碼
          qrInput.value = Array.from(scannedQRs).join(', ');
          qrInput.placeholder = '將顯示所有掃描的QR碼，用逗號分隔';
          setStatus('批量模式已啟用，可連續掃描多個QR碼', 'info');
        } else {
          // 單一模式：只顯示最後一個QR碼
          const lastQR = Array.from(scannedQRs).pop() || '';
          qrInput.value = lastQR;
          qrInput.placeholder = '將顯示最後掃描的QR碼';
          setStatus('單一模式已啟用，只記錄最後一個QR碼', 'info');
        }
      }

      // 查詢批號（支援多筆符合）
      async function queryAutoBatch() {
        const productName = document.getElementById('productName').value;
        const expiryDate = document.getElementById('expiryDate').value;
        const batchInput = document.getElementById('batchNumber');
        const statusDiv = document.getElementById('status');
        
        if (!productName || !expiryDate) {
          setBatchAsInput(batchInput, '', true);
          setStatus('請選擇產品名稱和效期', 'info');
          return;
        }

        setStatus('查詢批號中...', 'info');
        
        try {
          const gasUrl = document.getElementById('gasUrl').value.trim();
          if (!gasUrl) {
            setStatus('請先設定 Apps Script 服務網址', 'error');
            return;
          }

          const response = await fetch(gasUrl, {
            method: 'POST',
            // 使用簡單請求以避開 Apps Script 的 CORS 預檢
            headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
            body: JSON.stringify({
              action: 'lookupBatch',
              data: { productName, expiryDate }
            }),
          });
          
          const data = await response.json();
          
          console.log('批號查詢結果:', data);
          
          if (data && data.ok) {
            const batchResult = data.batch;
            
            if (!batchResult) {
              // 查無批號
              setBatchAsInput(batchInput, '查無批號', true);
              setStatus('查無批號，請確認產品名稱與效期是否正確', 'error');
            } else if (Array.isArray(batchResult)) {
              // 多筆符合，轉換為下拉選單
              setBatchAsSelect(batchInput, batchResult);
              setStatus(`找到 ${batchResult.length} 個批號，請選擇其中一個`, 'info');
            } else {
              // 單筆符合，直接填入
              setBatchAsInput(batchInput, batchResult, true);
              setStatus('批號已自動帶入', 'success');
            }
          } else {
            setBatchAsInput(batchInput, '查無批號', true);
            setStatus('查無批號，請確認產品名稱與效期是否正確', 'error');
          }
        } catch (error) {
          setBatchAsInput(batchInput, '查詢失敗', true);
          setStatus('批號查詢失敗，請稍後再試', 'error');
          console.error('批號查詢失敗:', error);
        }
      }

      // 設定批號為輸入框
      function setBatchAsInput(input, value, readonly = true) {
        // 移除現有的 select（如果有的話）
        const existingSelect = input.parentNode.querySelector('select.batch-select');
        if (existingSelect) {
          input.parentNode.removeChild(existingSelect);
        }
        
        input.type = 'text';
        input.value = value || '';
        input.readOnly = readonly;
        input.disabled = false;
        input.style.display = 'block';
        input.className = input.className.replace(' batch-select', '');
        
        // 根據值設定視覺效果
        if (!value) {
          // 空值：恢復正常樣式
          input.style.background = '#0f1115';
          input.style.border = '1px solid #2b313b';
          input.style.color = '#e8eaed';
        } else if (value.includes('查無批號') || value.includes('查詢失敗')) {
          // 錯誤狀態：紅色警告樣式
          input.style.background = '#ffebee';
          input.style.border = '2px solid #f44336';
          input.style.color = '#d32f2f';
          if (value.includes('查無批號')) {
            input.value = '❗ 查無批號';
          } else {
            input.value = '❌ 查詢失敗';
          }
        } else {
          // 成功狀態：綠色成功樣式
          input.style.background = '#e8f5e8';
          input.style.border = '2px solid #4caf50';
          input.style.color = '#2e7d32';
        }
      }

      // 設定批號為下拉選單
      function setBatchAsSelect(input, batches) {
        // 隱藏原本的 input
        input.style.display = 'none';
        
        // 移除現有的 select（如果有的話）
        const existingSelect = input.parentNode.querySelector('select.batch-select');
        if (existingSelect) {
          input.parentNode.removeChild(existingSelect);
        }
        
        // 建立新的 select
        const select = document.createElement('select');
        select.className = 'batch-select';
        select.style.width = '100%';
        select.style.padding = '10px 12px';
        select.style.borderRadius = '8px';
        select.style.border = '1px solid #2b313b';
        select.style.background = '#0f1115';
        select.style.color = '#e8eaed';
        
        // 加入提示選項
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = '請選擇批號';
        placeholder.disabled = true;
        placeholder.selected = true;
        select.appendChild(placeholder);
        
        // 加入批號選項
        batches.forEach(batch => {
          const option = document.createElement('option');
          option.value = batch;
          option.textContent = batch;
          select.appendChild(option);
        });
        
        // 綁定變更事件
        select.addEventListener('change', function() {
          if (this.value) {
            setStatus('批號已選擇', 'success');
          }
        });
        
        // 插入到 input 後面
        input.parentNode.insertBefore(select, input.nextSibling);
      }

      // 狀態顯示函數
      function setStatus(message, type = 'info') {
        const statusDiv = document.getElementById('status');
        if (statusDiv) {
          statusDiv.textContent = message || '';
          statusDiv.className = `status ${type}`;
        }
      }

      // 連線測試（可靜默）
      async function pingService(silent = true) {
        try {
          const gasUrl = document.getElementById('gasUrl').value.trim();
          if (!gasUrl) {
            if (!silent) setStatus('請先設定 Apps Script 服務網址', 'error');
            return false;
          }
          if (!silent) setStatus('測試連線中...', 'info');
          const res = await fetch(gasUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
            body: JSON.stringify({ action: 'ping' }),
          });
          const data = await res.json();
          if (data && data.ok) {
            if (!silent) setStatus('連線正常', 'success');
            return true;
          }
          if (!silent) setStatus('連線失敗', 'error');
          return false;
        } catch (e) {
          if (!silent) setStatus('連線失敗，請確認部署與權限', 'error');
          return false;
        }
      }

      // 啟動 QR 掃描器
      async function startBarcodeScanner() {
        try {
          const video = document.getElementById('video');
          if (!video) {
            setStatus('找不到相機元素', 'error');
            return;
          }

          // 檢查 QR Scanner 是否載入
          if (typeof QrScanner === 'undefined') {
            setStatus('QR 掃描器載入失敗，請重新整理頁面', 'error');
            return;
          }

          // 停止現有的掃描器
          if (qrScanner) {
            qrScanner.stop();
            qrScanner.destroy();
          }

          // 建立新的 QR 掃描器
          qrScanner = new QrScanner(
            video,
            result => {
              handleQRResult(result);
            },
            {
              onDecodeError: (error) => {
                // 解碼錯誤是正常的，不需要顯示
                console.debug('QR 解碼錯誤:', error);
              },
              highlightScanRegion: true,
              highlightCodeOutline: true,
            }
          );

          // 啟動掃描器
          await qrScanner.start();
          
          // 啟用/停用按鈕
          document.getElementById('startScan').disabled = true;
          document.getElementById('stopScan').disabled = false;
          
          setStatus('QR 掃描器已啟動，請將 QR 碼對準鏡頭', 'info');
          
        } catch (error) {
          console.error('啟動 QR 掃描器失敗:', error);
          setStatus('無法啟動 QR 掃描器，請確認相機權限', 'error');
        }
      }

      // 處理 QR 掃描結果
      function handleQRResult(result) {
        const qrText = result.data;
        
        // 調試：顯示實際掃描到的內容
        console.log('掃描到的QR碼內容:', qrText);
        console.log('QR碼長度:', qrText.length);
        console.log('QR碼字符編碼:', qrText.split('').map(c => c.charCodeAt(0)));
        
        // 驗證QR碼格式：必須是 https://jerosse.com.tw/ 開頭且後面有數字
        const jerossePattern = /^https:\/\/jerosse\.com\.tw\/(\d+)$/;
        const match = qrText.match(jerossePattern);
        
        if (!match) {
          setStatus(`QR碼格式不符，掃描到: "${qrText}"，請掃描正確的婕樂纖產品QR碼`, 'warning');
          return;
        }
        
        // 提取數字部分（保持完整格式，包括前導0）
        const qrNumber = match[1];
        
        // 檢查是否已掃描過（使用完整數字作為唯一識別）
        if (scannedQRs.has(qrNumber)) {
          setStatus('此 QR 碼已掃描過', 'warning');
          return;
        }

        // 記錄已掃描的 QR 碼（使用完整數字）
        scannedQRs.add(qrNumber);
        
        // 更新 QR 內容欄位
        const qrInput = document.getElementById('qrText');
        if (batchMode) {
          // 批量模式：顯示所有QR碼，用逗號分隔
          qrInput.value = Array.from(scannedQRs).join(', ');
        } else {
          // 單一模式：只顯示當前QR碼
          qrInput.value = qrNumber;
        }
        
        // 更新掃描記錄顯示
        updateScannedList();
        
        setStatus(`QR 碼掃描成功！已記錄 ${scannedQRs.size} 個 QR 碼`, 'success');
        
        // 震動提示（如果支援）
        if (navigator.vibrate) {
          navigator.vibrate(200);
        }
        
        // 使用原生API標記已掃描的QR碼（AR功能）
        markQRCodeAsScanned(result);
      }

      // AR標記管理器
      let arSession = null;
      let arMarkers = new Map(); // 儲存AR標記位置
      let isARSupported = false;

      // 初始化AR功能
      async function initAR() {
        try {
          if ('xr' in navigator) {
            isARSupported = await navigator.xr.isSessionSupported('immersive-ar');
            if (isARSupported) {
              console.log('AR功能已啟用');
              setStatus('AR標記功能已啟用', 'success');
            } else {
              console.log('AR功能不支援，使用Canvas標記');
              setStatus('AR功能不支援，使用Canvas標記', 'info');
            }
          }
        } catch (error) {
          console.log('AR初始化失敗:', error);
        }
      }

      // 使用原生API標記已掃描的QR碼（AR功能）
      async function markQRCodeAsScanned(result) {
        try {
          const qrText = result.data;
          const jerossePattern = /^https:\/\/jerosse\.com\.tw\/(\d+)$/;
          const match = qrText.match(jerossePattern);
          
          if (!match) return;
          
          const qrNumber = match[1];
          
          if (isARSupported && arSession) {
            // 使用WebXR AR標記
            await createARMarker(result, qrNumber);
          } else {
            // 使用Canvas標記
            createCanvasMarker(result, qrNumber);
          }
        } catch (error) {
          console.log('AR標記功能不可用:', error);
          // 降級到Canvas標記
          createCanvasMarker(result, qrNumber);
        }
      }

      // 創建AR標記（WebXR）
      async function createARMarker(result, qrNumber) {
        try {
          if (!arSession) {
            // 啟動AR會話
            arSession = await navigator.xr.requestSession('immersive-ar', {
              requiredFeatures: ['local'],
              optionalFeatures: ['hit-test']
            });
            
            // 設定AR會話事件
            arSession.addEventListener('end', () => {
              arSession = null;
              arMarkers.clear();
            });
          }

          // 獲取QR碼在3D空間中的位置
          const qrPosition = await getQRCode3DPosition(result);
          
          if (qrPosition) {
            // 創建AR標記
            const marker = {
              id: qrNumber,
              position: qrPosition,
              timestamp: Date.now(),
              element: createARMarkerElement(qrNumber)
            };
            
            arMarkers.set(qrNumber, marker);
            console.log(`AR標記已創建: ${qrNumber}`);
          }
        } catch (error) {
          console.error('創建AR標記失敗:', error);
        }
      }

      // 獲取QR碼在3D空間中的位置
      async function getQRCode3DPosition(result) {
        try {
          // 使用WebXR的hit-test功能
          const referenceSpace = await arSession.requestReferenceSpace('local');
          const hitTestSource = await arSession.requestHitTestSource({ space: referenceSpace });
          
          // 將QR碼的2D位置轉換為3D位置
          const qrRect = result.location;
          const x = (qrRect.x + qrRect.width / 2) / window.innerWidth;
          const y = (qrRect.y + qrRect.height / 2) / window.innerHeight;
          
          // 創建射線進行hit-test
          const ray = new XRRay(
            new DOMPoint(0, 0, 0),
            new DOMPoint(x - 0.5, y - 0.5, -1)
          );
          
          const hitTestResults = await hitTestSource.requestHitTest(ray, referenceSpace);
          
          if (hitTestResults.length > 0) {
            return hitTestResults[0].hitMatrix;
          }
        } catch (error) {
          console.error('獲取3D位置失敗:', error);
        }
        return null;
      }

      // 創建AR標記元素
      function createARMarkerElement(qrNumber) {
        const marker = document.createElement('div');
        marker.className = 'ar-marker';
        marker.innerHTML = `
          <div class="ar-marker-circle">
            <div class="ar-marker-check">✓</div>
            <div class="ar-marker-number">${qrNumber}</div>
          </div>
        `;
        marker.style.cssText = `
          position: absolute;
          width: 60px;
          height: 60px;
          pointer-events: none;
          z-index: 1000;
        `;
        return marker;
      }

      // 創建Canvas標記（降級方案）
      function createCanvasMarker(result, qrNumber) {
        const canvas = document.getElementById('overlay');
        if (canvas && result.location) {
          const ctx = canvas.getContext('2d');
          const rect = result.location;
          
          // 繪製橙色圓圈標記（類似圖中的標記）
          ctx.strokeStyle = '#FF9800';
          ctx.fillStyle = 'rgba(255, 152, 0, 0.3)';
          ctx.lineWidth = 4;
          ctx.beginPath();
          ctx.arc(rect.x + rect.width/2, rect.y + rect.height/2, Math.max(rect.width, rect.height)/2 + 15, 0, 2 * Math.PI);
          ctx.fill();
          ctx.stroke();
          
          // 繪製"✓"標記
          ctx.fillStyle = '#FF9800';
          ctx.font = 'bold 24px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('✓', rect.x + rect.width/2, rect.y + rect.height/2 + 8);
          
          // 繪製QR碼編號
          ctx.font = 'bold 12px Arial';
          ctx.fillText(qrNumber, rect.x + rect.width/2, rect.y + rect.height/2 + 25);
          
          // 標記會持續顯示，直到頁面重新整理
          console.log(`Canvas標記已創建: ${qrNumber}`);
        }
      }

      // 啟動AR會話
      async function startARSession() {
        try {
          if (isARSupported) {
            arSession = await navigator.xr.requestSession('immersive-ar');
            setStatus('AR會話已啟動', 'success');
            return true;
          } else {
            setStatus('AR功能不支援', 'warning');
            return false;
          }
        } catch (error) {
          console.error('啟動AR會話失敗:', error);
          setStatus('AR會話啟動失敗', 'error');
          return false;
        }
      }

      // 停止AR會話
      function stopARSession() {
        if (arSession) {
          arSession.end();
          arSession = null;
          arMarkers.clear();
          setStatus('AR會話已停止', 'info');
        }
      }

      // 更新掃描記錄列表
      function updateScannedList() {
        const listContainer = document.getElementById('scannedList');
        if (!listContainer) return;

        listContainer.innerHTML = '';
        
        if (scannedQRs.size === 0) {
          listContainer.innerHTML = '<p class="small">尚未掃描任何 QR 碼</p>';
          return;
        }

        const title = document.createElement('h4');
        title.textContent = `已掃描 ${scannedQRs.size} 個 QR 碼：`;
        listContainer.appendChild(title);

        scannedQRs.forEach((qrNumber, index) => {
          const item = document.createElement('div');
          item.className = 'scanned-item';
          item.innerHTML = `
            <span class="qr-number">${index + 1}.</span>
            <span class="qr-content">https://jerosse.com.tw/${qrNumber}</span>
            <button class="remove-btn" onclick="removeQR('${qrNumber}')">×</button>
          `;
          listContainer.appendChild(item);
        });
      }

      // 移除 QR 碼
      function removeQR(qrNumber) {
        scannedQRs.delete(qrNumber);
        updateScannedList();
        
        // 如果移除的是當前 QR 內容，清空欄位
        if (document.getElementById('qrText').value === qrNumber) {
          document.getElementById('qrText').value = '';
        }
        
        setStatus(`已移除 QR 碼，剩餘 ${scannedQRs.size} 個`, 'info');
      }

      // 清空所有掃描記錄
      function clearAllQRs() {
        scannedQRs.clear();
        document.getElementById('qrText').value = '';
        updateScannedList();
        setStatus('已清空所有掃描記錄', 'info');
      }

      // 停止掃描
      function stopBarcodeScanner() {
        if (qrScanner) {
          qrScanner.stop();
          qrScanner.destroy();
          qrScanner = null;
        }
        
        // 啟用/停用按鈕
        document.getElementById('startScan').disabled = false;
        document.getElementById('stopScan').disabled = true;
        
        setStatus('QR 掃描器已停止', 'info');
      }

      // 手動輸入 QR 碼
      function manualQRInput() {
        const qrText = prompt('請輸入 QR 碼內容：');
        if (qrText && qrText.trim()) {
          const trimmedQR = qrText.trim();
          
          // 驗證QR碼格式：必須是 https://jerosse.com.tw/ 開頭且後面有數字
          const jerossePattern = /^https:\/\/jerosse\.com\.tw\/(\d+)$/;
          const match = trimmedQR.match(jerossePattern);
          
          if (!match) {
            setStatus('QR碼格式不符，請輸入正確的婕樂纖產品QR碼', 'warning');
            return;
          }
          
          // 提取數字部分（保持完整格式，包括前導0）
          const qrNumber = match[1];
          
          // 檢查是否已存在
          if (scannedQRs.has(qrNumber)) {
            setStatus('此 QR 碼已存在於記錄中', 'warning');
            return;
          }
          
          // 添加到掃描記錄（使用完整數字）
          scannedQRs.add(qrNumber);
          document.getElementById('qrText').value = qrNumber;
          updateScannedList();
          setStatus(`QR 碼已手動輸入！已記錄 ${scannedQRs.size} 個 QR 碼`, 'success');
        }
      }

      // 處理表單提交
      async function handleFormSubmit(event) {
        event.preventDefault();
        
        const gasUrl = document.getElementById('gasUrl').value.trim();
        if (!gasUrl) {
          setStatus('請先設定 Apps Script 服務網址', 'error');
          return;
        }

        // 取得表單資料
        const productName = document.getElementById('productName').value;
        const expiryDate = document.getElementById('expiryDate').value;
        const qrText = document.getElementById('qrText').value;
        const staffName = document.getElementById('staffName').value;
        
        // 取得批號（可能是 input 或 select）
        let batchNumber = '';
        const batchInput = document.getElementById('batchNumber');
        const batchSelect = document.querySelector('select.batch-select');
        
        if (batchSelect && batchSelect.style.display !== 'none') {
          batchNumber = batchSelect.value;
        } else {
          batchNumber = batchInput.value;
        }

        // 驗證必填欄位
        if (!productName || !expiryDate || !batchNumber || !qrText || !staffName) {
          setStatus('請完整填寫所有必填欄位', 'error');
          return;
        }
        
        // 處理QR碼：批量模式時分割多個QR碼
        const qrCodes = qrText.split(',').map(qr => qr.trim()).filter(qr => qr);
        if (qrCodes.length === 0) {
          setStatus('請至少掃描一個QR碼', 'error');
          return;
        }

        setStatus(`送出中... (${qrCodes.length} 筆記錄)`, 'info');
        
        try {
          // 準備批量記錄
          const records = qrCodes.map(qrCode => ({
            productName: productName.trim(),
            expiryDate: expiryDate.trim(),
            batchNumber: batchNumber.trim(),
            qrText: qrCode, // 單一QR碼
            staffName: staffName.trim(),
            timestamp: new Date().toISOString(),
          }));
          
          // 調試：確認批量記錄
          console.log('批量提交記錄:', records);
          console.log('記錄數量:', records.length);

          const response = await fetch(gasUrl, {
            method: 'POST',
            // 使用簡單請求以避開 Apps Script 的 CORS 預檢
            headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
            body: JSON.stringify({ action: 'appendBatch', records: records }),
          });
          
          const data = await response.json();
          
          if (data && data.ok && data.results) {
            const successCount = data.results.filter(r => r.ok).length;
            const errorCount = data.results.filter(r => !r.ok).length;
            
            setStatus(`已成功寫入 ${successCount} 筆記錄${errorCount > 0 ? `，${errorCount} 筆失敗` : ''}`, 'success');
            
            // 清空表單
            document.getElementById('recordForm').reset();
            document.getElementById('qrText').value = '';
            document.getElementById('staffName').value = '';
            
            // 清空掃描記錄
            scannedQRs.clear();
            updateScannedList();
            
            // 重置批號欄位
            setBatchAsInput(batchInput, '', true);
            
            // 重置批量模式
            document.getElementById('batchMode').checked = false;
            batchMode = false;
            
          } else {
            setStatus(`批量寫入失敗：${(data && data.error) || '未知錯誤'}`, 'error');
          }
        } catch (error) {
          setStatus('連線失敗，請確認網路或服務部署', 'error');
          console.error('表單提交失敗:', error);
        }
      }

      // 綁定事件
      document.addEventListener('DOMContentLoaded', function() {
        const productSelect = document.getElementById('productName');
        const expiryInput = document.getElementById('expiryDate');
        const startScanBtn = document.getElementById('startScan');
        const stopScanBtn = document.getElementById('stopScan');
        const gasUrlInput = document.getElementById('gasUrl');
        const pingBtn = document.getElementById('pingService');
        
        if (productSelect) {
          productSelect.addEventListener('change', queryAutoBatch);
        }
        if (expiryInput) {
          expiryInput.addEventListener('change', queryAutoBatch);
        }
        if (startScanBtn) {
          startScanBtn.addEventListener('click', startBarcodeScanner);
        }
        if (stopScanBtn) {
          stopScanBtn.addEventListener('click', stopBarcodeScanner);
        }
        
        // 載入/保存 Apps Script URL
        const DEFAULT_GAS_URL = 'https://script.google.com/macros/s/AKfycbxqIV8fevVTSjcykeaS7N2LDVIzDNCYfefwxqFCunC-5JAZGhelwMtqtAghRaDWp1Lf/exec';
        try {
          const saved = localStorage.getItem('gasUrl');
          gasUrlInput.value = (saved && saved.trim()) ? saved.trim() : DEFAULT_GAS_URL;
        } catch {}
        if (gasUrlInput) {
          gasUrlInput.addEventListener('change', function() {
            try { localStorage.setItem('gasUrl', this.value.trim()); } catch {}
          });
        }

        // 測試連線
        if (pingBtn) {
          pingBtn.addEventListener('click', function() { pingService(false); });
        }

        // 手動輸入 QR 碼按鈕
        const manualQRBtn = document.getElementById('manualQR');
        if (manualQRBtn) {
          manualQRBtn.addEventListener('click', manualQRInput);
        }

        // AR標記按鈕
        const startARBtn = document.getElementById('startAR');
        const stopARBtn = document.getElementById('stopAR');
        if (startARBtn) {
          startARBtn.addEventListener('click', async function() {
            const success = await startARSession();
            if (success) {
              startARBtn.disabled = true;
              stopARBtn.disabled = false;
            }
          });
        }
        if (stopARBtn) {
          stopARBtn.addEventListener('click', function() {
            stopARSession();
            startARBtn.disabled = false;
            stopARBtn.disabled = true;
          });
        }

        // 表單提交事件
        const recordForm = document.getElementById('recordForm');
        if (recordForm) {
          recordForm.addEventListener('submit', handleFormSubmit);
        }
        // 開啟頁面自動連線測試（靜默），失敗才提示
        pingService(true).then(ok => { if (!ok) setStatus('無法連線 Apps Script，請確認網址或部署', 'warning'); });
        
        // 初始化AR功能
        initAR();
      });
    </script>
    <!-- 移除 ZXingBrowser，改用原生相機 API -->
  </body>
  </html>


