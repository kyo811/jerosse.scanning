<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>ç”¢å“æƒæèˆ‡ç´€éŒ„</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      /* ARæ¨™è¨˜æ¨£å¼ */
      .ar-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 3;
      }
      
      .scan-order-section {
        margin: 12px 0;
        padding: 12px;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border-radius: 8px;
        color: white;
      }
      
      .scan-order-section h4 {
        margin: 0 0 8px 0;
        font-size: 14px;
        text-align: center;
      }
      
      .scan-order-list {
        max-height: 200px;
        overflow-y: auto;
      }
      
      .order-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 8px;
        margin: 2px 0;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        font-size: 12px;
      }
      
      .order-number {
        background: #FFD700;
        color: #000;
        padding: 2px 6px;
        border-radius: 50%;
        font-weight: bold;
        min-width: 20px;
        text-align: center;
      }
      
      .order-qr {
        flex: 1;
        margin: 0 8px;
        font-weight: bold;
      }
      
      .order-time {
        font-size: 10px;
        opacity: 0.8;
      }
      
      /* è˜‹æœåŸç”ŸARæ¨™è¨˜æ¨£å¼ */
      #preview-container {
        position: relative;
        display: inline-block;
        width: 100%;
        max-width: 640px;
        margin: 0 auto;
      }

      .ar-marker-3d {
        position: absolute;
        pointer-events: none;
        z-index: 1000;
      }
      
      .ar-marker-content {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      
      .ar-order-circle {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #FFD700, #FFA500);
        border: 3px solid #000;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: arPulse 2s infinite;
      }
      
      .ar-order-number {
        font-size: 18px;
        font-weight: bold;
        color: #000;
        text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
      }
      
      .ar-qr-label {
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        border: 2px solid #fff;
      }
      
      .ar-checkmark {
        width: 30px;
        height: 30px;
        background: linear-gradient(135deg, #00FF00, #00CC00);
        border: 2px solid #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: bold;
        color: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        animation: arBounce 1s ease-out;
      }
      
      @keyframes arMarkerAppear {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.5);
        }
        100% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }
      
      @keyframes arPulse {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
      
      @keyframes arBounce {
        0% {
          transform: scale(0);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }
      
      .ar-marker {
        position: absolute;
        pointer-events: none;
        z-index: 1000;
      }
      
      .ar-marker-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(255, 152, 0, 0.3);
        border: 4px solid #FF9800;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        animation: pulse 2s infinite;
      }
      
      .ar-marker-check {
        color: #FF9800;
        font-size: 24px;
        font-weight: bold;
        line-height: 1;
      }
      
      .ar-marker-number {
        color: #FF9800;
        font-size: 10px;
        font-weight: bold;
        margin-top: 2px;
      }
      
      @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
      }
      
      /* æ¸…é™¤æ¨™è¨˜æŒ‰éˆ•æ¨£å¼ */
      #clearMarkers {
        background: linear-gradient(45deg, #f44336, #e91e63);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: bold;
        margin: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      #clearMarkers:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(244, 67, 54, 0.3);
      }
      
      /* æ‰¹é‡æƒæçµ±è¨ˆæ¨£å¼ */
      .batch-stats {
        margin: 12px 0;
        animation: fadeIn 0.5s ease-in;
      }
      
      .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 16px;
        color: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
      
      .stats-card h4 {
        margin: 0 0 12px 0;
        font-size: 16px;
        text-align: center;
      }
      
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }
      
      .stat-item {
        text-align: center;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 8px;
      }
      
      .stat-number {
        display: block;
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 4px;
      }
      
      .stat-label {
        font-size: 12px;
        opacity: 0.9;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      /* QRç¢¼æƒæè¨ˆæ•¸å™¨æ¨£å¼ */
      .qr-counter {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 1001;
        pointer-events: none;
      }
      
      .counter-badge {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        border-radius: 25px;
        padding: 12px 18px;
        color: white;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.2);
        animation: counterPulse 0.3s ease-out;
      }
      
      .counter-icon {
        font-size: 20px;
        animation: iconBounce 0.5s ease-out;
      }
      
      .counter-text {
        font-size: 14px;
        font-weight: 500;
        opacity: 0.9;
      }
      
      .counter-number {
        font-size: 24px;
        font-weight: bold;
        color: #4CAF50;
        text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        min-width: 30px;
        text-align: center;
        transition: all 0.3s ease;
      }
      
      .counter-label {
        font-size: 12px;
        opacity: 0.8;
      }
      
      /* è¨ˆæ•¸å™¨å‹•ç•«æ•ˆæœ */
      @keyframes counterPulse {
        0% { 
          transform: scale(0.8); 
          opacity: 0; 
        }
        50% { 
          transform: scale(1.1); 
        }
        100% { 
          transform: scale(1); 
          opacity: 1; 
        }
      }
      
      @keyframes iconBounce {
        0%, 20%, 50%, 80%, 100% { 
          transform: translateY(0); 
        }
        40% { 
          transform: translateY(-8px); 
        }
        60% { 
          transform: translateY(-4px); 
        }
      }
      
      /* æ•¸å­—æ›´æ–°å‹•ç•« */
      .counter-number.updated {
        animation: numberUpdate 0.5s ease-out;
      }
      
      @keyframes numberUpdate {
        0% { 
          transform: scale(1); 
          color: #4CAF50; 
        }
        50% { 
          transform: scale(1.3); 
          color: #FFD700; 
        }
        100% { 
          transform: scale(1); 
          color: #4CAF50; 
        }
      }
      
    </style>
  </head>
  <body>
    <main class="container">
      <h1>ç”¢å“æƒæèˆ‡ç´€éŒ„</h1>

      <section class="card">
        <h2>æƒæ QR ç¢¼</h2>
        <div id="preview-container">
          <video id="video" playsinline muted></video>
          <canvas id="overlay" class="overlay"></canvas>
          <canvas id="arCanvas" class="ar-canvas"></canvas>
          <!-- QRç¢¼æƒæè¨ˆæ•¸å™¨ -->
          <div id="qrCounter" class="qr-counter" style="display: none;">
            <div class="counter-badge">
              <span class="counter-icon">ğŸ“±</span>
              <span class="counter-text">å·²æƒæ</span>
              <span class="counter-number" id="counterNumber">0</span>
              <span class="counter-label">å€‹QRç¢¼</span>
            </div>
          </div>
        </div>
        <div class="row">
          <button id="startScan">é–‹å§‹æƒæ</button>
          <button id="stopScan" disabled>åœæ­¢æƒæ</button>
          <button id="manualQR" type="button">æ‰‹å‹•è¼¸å…¥ QR</button>
        </div>
        <div class="row">
          <button id="clearMarkers" type="button">æ¸…é™¤æ‰€æœ‰æ¨™è¨˜</button>
          <button id="refocusBtn" type="button" style="background: linear-gradient(45deg, #FF9800, #F57C00); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; margin: 3px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;">ğŸ” é‡æ–°å°ç„¦</button>
        </div>
        <div class="row">
          <button id="multiScanBtn" type="button" style="background: linear-gradient(45deg, #4CAF50, #45a049); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; margin: 5px; cursor: pointer; transition: all 0.3s ease; font-size: 16px;">ğŸ“± å¤šQRç¢¼æƒææ¨¡å¼</button>
          <button id="testARBtn" type="button" style="background: linear-gradient(45deg, #FF9800, #F57C00); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; margin: 3px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;">ğŸ§ª æ¸¬è©¦ARæ¨™è¨˜</button>
          <button id="simpleTestBtn" type="button" style="background: linear-gradient(45deg, #E91E63, #C2185B); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; margin: 3px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;">ğŸ¯ ç°¡å–®æ¸¬è©¦</button>
        </div>
        <div class="row">
          <button id="checkARBtn" type="button" style="background: linear-gradient(45deg, #9C27B0, #7B1FA2); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; margin: 3px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;">ğŸ” æª¢æŸ¥ARç‹€æ…‹</button>
          <button id="initARBtn" type="button" style="background: linear-gradient(45deg, #607D8B, #455A64); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; margin: 3px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;">ğŸ”§ æ‰‹å‹•åˆå§‹åŒ–AR</button>
          <button id="startWebXRBtn" type="button" style="background: linear-gradient(45deg, #FF6B6B, #E53E3E); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; margin: 3px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;">ğŸ å•Ÿå‹•WebXR AR</button>
          <button id="test3DCoordsBtn" type="button" style="background: linear-gradient(45deg, #00BCD4, #0097A7); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; margin: 3px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;">ğŸ“ æ¸¬è©¦3Dåº§æ¨™</button>
        </div>
        <div class="hint">è‹¥ç„¡æ³•é–‹å•Ÿé¡é ­ï¼Œè«‹ç¢ºèªç€è¦½å™¨æ¬Šé™æˆ–æ”¹ç”¨ Safariã€‚</div>
        <div class="hint" style="color: #4CAF50; font-weight: bold;">
          ğŸ’¡ å¤šQRç¢¼æƒæï¼šä¸€æ¬¡å¯è­˜åˆ¥10å€‹ä»¥ä¸ŠQRç¢¼ï¼Œè‡ªå‹•å°ç„¦ä¸¦æ¨™è¨˜å·²æƒæé …ç›®
        </div>
        <div id="scanningTips" class="hint" style="color: #FF9800; font-weight: bold; display: none;">
          ğŸ’¡ æƒææç¤ºï¼šè«‹ä¿æŒQRç¢¼æ¸…æ™°å¯è¦‹ï¼Œé¿å…æ‰‹æŠ–ï¼Œå¯å˜—è©¦èª¿æ•´è·é›¢
        </div>
        
        <!-- æ‰¹é‡æƒæçµ±è¨ˆ -->
        <div id="batchStats" class="batch-stats" style="display: none;">
          <div class="stats-card">
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-number" id="totalScanned">0</div>
                <div class="stat-label">å·²æƒæ</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="scanningSpeed">0</div>
                <div class="stat-label">æƒæ/ç§’</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="uniqueCodes">0</div>
                <div class="stat-label">å”¯ä¸€QRç¢¼</div>
              </div>
            </div>
          </div>
        </div>

        <!-- æƒæé †åºé¡¯ç¤º -->
        <div id="scanOrderSection" class="scan-order-section" style="display: none;">
          <h4>ğŸ“‹ æƒæé †åº</h4>
          <div id="scanOrderList" class="scan-order-list"></div>
        </div>

        <!-- æƒæè¨˜éŒ„å€åŸŸ -->
        <div id="scannedList" class="scanned-list">
          <p class="small">å°šæœªæƒæä»»ä½• QR ç¢¼</p>
        </div>
            <div class="stats-grid">
              <div class="stat-item">
                <span class="stat-number" id="totalScanned">0</span>
                <span class="stat-label">å·²æƒæ</span>
              </div>
              <div class="stat-item">
                <span class="stat-number" id="scanningSpeed">0</span>
                <span class="stat-label">æƒæ/ç§’</span>
              </div>
              <div class="stat-item">
                <span class="stat-number" id="uniqueCodes">0</span>
                <span class="stat-label">ä¸é‡è¤‡</span>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <button id="clearAllQRs" type="button" onclick="clearAllQRs()">æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„</button>
        </div>
      </section>

      <section class="card">
        <h2>è¼¸å…¥è³‡æ–™</h2>
        <form id="recordForm">
          <label>
            é‡å·¥åœ°é»
            <select id="reworkType" required onchange="updateProductOptions()">
              <option value="">è«‹é¸æ“‡é‡å·¥åœ°é»</option>
              <option value="å» å…§é‡å·¥">å» å…§é‡å·¥</option>
              <option value="å» å¤–é‡å·¥">å» å¤–é‡å·¥</option>
            </select>
          </label>

          <label>
            ç”¢å“åç¨±
            <select id="productName" required disabled>
              <option value="">è«‹å…ˆé¸æ“‡é‡å·¥åœ°é»</option>
            </select>
          </label>

          <label>
            æ•ˆæœŸ
            <input type="date" id="expiryDate" required />
          </label>

          <label>
            æ‰¹è™Ÿï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰
            <input type="text" id="batchNumber" required readonly />
          </label>

          <label>
            QR å…§å®¹ï¼ˆå”¯ä¸€æœ¬ç›’ï¼‰
            <input type="text" id="qrText" required readonly />
          </label>
          
          <label>
            æ‰¹é‡æƒææ¨¡å¼
            <input type="checkbox" id="batchMode" onchange="toggleBatchMode()" checked />
            <span class="small">âœ… å·²å•Ÿç”¨ï¼šå¯åŒæ™‚æƒæå¤šå€‹QRç¢¼ï¼ˆæ¨è–¦ï¼‰</span>
          </label>

          <label>
            å¡«å¯«äººå“¡
            <input type="text" id="staffName" required placeholder="è«‹è¼¸å…¥å¡«å¯«äººå“¡å§“å" />
          </label>

          <div class="row">
            <button type="submit" id="submitBtn">é€å‡ºåˆ°è©¦ç®—è¡¨</button>
          </div>
          <div id="status" class="status"></div>
        </form>
      </section>

      <section class="card">
        <h2>Apps Script æœå‹™è¨­å®š</h2>
        <p class="small">æ‰¹è™Ÿæœƒè‡ªå‹•å¾ã€Œå…¨ç”¢å“æ‰¹è™Ÿç‰ˆæœ¬ã€è©¦ç®—è¡¨æŸ¥è©¢å¸¶å…¥</p>
        <div class="row">
          <label class="inline">
            Apps Script æœå‹™ç¶²å€
            <input type="url" id="gasUrl" placeholder="https://script.google.com/macros/s/xxx/exec" />
          </label>
        </div>
        <details>
          <summary>é€£ç·šæ¸¬è©¦èˆ‡è¨­å®š</summary>
          <div class="row">
            <button id="pingService" type="button">æ¸¬è©¦é€£ç·š</button>
            <span id="pingResult" class="status"></span>
          </div>
        </details>
      </section>

      <footer>
        <small>å»ºè­°ä½¿ç”¨ iPhone çš„ Safari é–‹å•Ÿæ­¤é ã€‚è³‡æ–™åƒ…æ–¼é€å‡ºæ™‚å¯«å…¥ Google è©¦ç®—è¡¨ã€‚</small>
      </footer>
    </main>

    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <script>
      // ç”¢å“åˆ†é¡è³‡æ–™
      const PRODUCT_CATEGORIES = {
        "å» å…§é‡å·¥": ["çº–çº–é£²", "è‚½çº–é£²-å¯å¯", "åšç„™å¥¶èŒ¶", "æ°´å…‰éŒ ", "æ°´å…‰é¢è†œ", "é›ªèšéœ²", "å©•è‚Œé›¶", "èº«é«”æ²¹", "è­·æ‰‹éœœ", "ç»å°¿é…¸", "æ´—é«®éœ²", "é¤Šé«®æ¶²", "è‘‰é»ƒç´ EXé£²", "è‘‰é»ƒç´ æœå‡", "æ­£å† èŒ¶"],
        "å» å¤–é‡å·¥": ["çº–é£„éŒ ", "çˆ†çº–éŒ ", "çº–é…µå®¿", "ç´«çº–é£²", "ç›Šç”ŸèŒ", "å›ºæ¨‚çº–"]
      };

      // QR æƒæå™¨å¯¦ä¾‹
      let qrScanner = null;
      let scannedQRs = new Set(); // è¨˜éŒ„å·²æƒæçš„ QR ç¢¼ï¼Œé¿å…é‡è¤‡
      let batchMode = true; // æ‰¹é‡æ¨¡å¼ç‹€æ…‹ï¼ˆé è¨­å•Ÿç”¨ï¼‰
      
      // æ‰¹é‡æƒæçµ±è¨ˆ
      let scanStats = {
        totalScanned: 0,
        startTime: null,
        lastScanTime: null
      };
      
      // å¤šQRç¢¼æƒææ¨¡å¼
      let multiScanMode = true; // å¤šQRç¢¼æƒææ¨¡å¼
      
      // æƒæç‹€æ…‹è¿½è¹¤
      let scanAttempts = 0;
      let lastScanTime = 0;
      let scanningTipsTimeout = null;
      
      // ARæ¨™è¨˜ç³»çµ±
      let qrMarkers = new Map(); // å„²å­˜QRç¢¼ä½ç½®å’Œæ¨™è¨˜è³‡è¨Š
      let canvas = null; // ARæ¨™è¨˜ç•«å¸ƒ
      let ctx = null; // ç•«å¸ƒä¸Šä¸‹æ–‡
      let isAutoFocusing = false; // è‡ªå‹•å°ç„¦ç‹€æ…‹
      let scanOrder = []; // æƒæé †åºè¨˜éŒ„
      let scanCounter = 0; // æƒæè¨ˆæ•¸å™¨
      let arScene = null; // ARå ´æ™¯
      let arMarkerElements = new Map(); // ARæ¨™è¨˜å¯¦ä¾‹

      // å…¨åŸŸå‡½æ•¸ï¼šæ›´æ–°ç”¢å“é¸é …
      function updateProductOptions() {
        const reworkType = document.getElementById('reworkType').value;
        const productSelect = document.getElementById('productName');
        
        console.log('updateProductOptions called with reworkType:', reworkType);
        
        // æ¸…ç©ºç¾æœ‰é¸é …
        productSelect.innerHTML = '';
        
        if (!reworkType) {
          productSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡é‡å·¥åœ°é»</option>';
          productSelect.disabled = true;
          // æ¸…ç©ºæ‰¹è™Ÿ
          document.getElementById('batchNumber').value = '';
          return;
        }
        
        // å•Ÿç”¨ç”¢å“é¸æ“‡
        productSelect.disabled = false;
        productSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç”¢å“</option>';
        
        // åŠ å…¥è©²é¡åˆ¥çš„ç”¢å“
        const products = PRODUCT_CATEGORIES[reworkType] || [];
        console.log('Updating products for:', reworkType, products);
        
        products.forEach(product => {
          const option = document.createElement('option');
          option.value = product;
          option.textContent = product;
          productSelect.appendChild(option);
        });
        
        console.log('Product options updated, total options:', productSelect.options.length);
      }

      // åˆ‡æ›æ‰¹é‡æ¨¡å¼
      function toggleBatchMode() {
        batchMode = document.getElementById('batchMode').checked;
        const qrInput = document.getElementById('qrText');
        
        if (batchMode) {
          // æ‰¹é‡æ¨¡å¼ï¼šé¡¯ç¤ºæ‰€æœ‰æƒæçš„QRç¢¼
          qrInput.value = Array.from(scannedQRs).join(', ');
          qrInput.placeholder = 'å°‡é¡¯ç¤ºæ‰€æœ‰æƒæçš„QRç¢¼ï¼Œç”¨é€—è™Ÿåˆ†éš”';
          setStatus('âœ… æ‰¹é‡æƒææ¨¡å¼å·²å•Ÿç”¨ï¼Œå¯åŒæ™‚è­˜åˆ¥å¤šå€‹QRç¢¼', 'success');
          
          // å¦‚æœæƒæå™¨æ­£åœ¨é‹è¡Œï¼Œé‡æ–°å•Ÿå‹•ä»¥å„ªåŒ–å¤šQRç¢¼æƒæ
          if (qrScanner && qrScanner._active) {
            setTimeout(() => {
              setStatus('ğŸ”„ å·²å„ªåŒ–æƒæå™¨è¨­å®šï¼Œæ”¯æ´å¤šQRç¢¼åŒæ™‚è­˜åˆ¥', 'info');
            }, 1000);
          }
        } else {
          // å–®ä¸€æ¨¡å¼ï¼šåªé¡¯ç¤ºæœ€å¾Œä¸€å€‹QRç¢¼
          const lastQR = Array.from(scannedQRs).pop() || '';
          qrInput.value = lastQR;
          qrInput.placeholder = 'å°‡é¡¯ç¤ºæœ€å¾Œæƒæçš„QRç¢¼';
          setStatus('å–®ä¸€æ¨¡å¼å·²å•Ÿç”¨ï¼Œåªè¨˜éŒ„æœ€å¾Œä¸€å€‹QRç¢¼', 'info');
        }
      }

      // æŸ¥è©¢æ‰¹è™Ÿï¼ˆæ”¯æ´å¤šç­†ç¬¦åˆï¼‰
      async function queryAutoBatch() {
        const productName = document.getElementById('productName').value;
        const expiryDate = document.getElementById('expiryDate').value;
        const batchInput = document.getElementById('batchNumber');
        const statusDiv = document.getElementById('status');
        
        if (!productName || !expiryDate) {
          setBatchAsInput(batchInput, '', true);
          setStatus('è«‹é¸æ“‡ç”¢å“åç¨±å’Œæ•ˆæœŸ', 'info');
          return;
        }

        setStatus('æŸ¥è©¢æ‰¹è™Ÿä¸­...', 'info');
        
        try {
          const gasUrl = document.getElementById('gasUrl').value.trim();
          if (!gasUrl) {
            setStatus('è«‹å…ˆè¨­å®š Apps Script æœå‹™ç¶²å€', 'error');
            return;
          }

          const response = await fetch(gasUrl, {
            method: 'POST',
            // ä½¿ç”¨ç°¡å–®è«‹æ±‚ä»¥é¿é–‹ Apps Script çš„ CORS é æª¢
            headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
            body: JSON.stringify({
              action: 'lookupBatch',
              data: { productName, expiryDate }
            }),
          });
          
          const data = await response.json();
          
          console.log('æ‰¹è™ŸæŸ¥è©¢çµæœ:', data);
          
          if (data && data.ok) {
            const batchResult = data.batch;
            
            if (!batchResult) {
              // æŸ¥ç„¡æ‰¹è™Ÿ
              setBatchAsInput(batchInput, 'æŸ¥ç„¡æ‰¹è™Ÿ', true);
              setStatus('æŸ¥ç„¡æ‰¹è™Ÿï¼Œè«‹ç¢ºèªç”¢å“åç¨±èˆ‡æ•ˆæœŸæ˜¯å¦æ­£ç¢º', 'error');
            } else if (Array.isArray(batchResult)) {
              // å¤šç­†ç¬¦åˆï¼Œè½‰æ›ç‚ºä¸‹æ‹‰é¸å–®
              setBatchAsSelect(batchInput, batchResult);
              setStatus(`æ‰¾åˆ° ${batchResult.length} å€‹æ‰¹è™Ÿï¼Œè«‹é¸æ“‡å…¶ä¸­ä¸€å€‹`, 'info');
            } else {
              // å–®ç­†ç¬¦åˆï¼Œç›´æ¥å¡«å…¥
              setBatchAsInput(batchInput, batchResult, true);
              setStatus('æ‰¹è™Ÿå·²è‡ªå‹•å¸¶å…¥', 'success');
            }
          } else {
            setBatchAsInput(batchInput, 'æŸ¥ç„¡æ‰¹è™Ÿ', true);
            setStatus('æŸ¥ç„¡æ‰¹è™Ÿï¼Œè«‹ç¢ºèªç”¢å“åç¨±èˆ‡æ•ˆæœŸæ˜¯å¦æ­£ç¢º', 'error');
          }
        } catch (error) {
          setBatchAsInput(batchInput, 'æŸ¥è©¢å¤±æ•—', true);
          setStatus('æ‰¹è™ŸæŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
          console.error('æ‰¹è™ŸæŸ¥è©¢å¤±æ•—:', error);
        }
      }

      // è¨­å®šæ‰¹è™Ÿç‚ºè¼¸å…¥æ¡†
      function setBatchAsInput(input, value, readonly = true) {
        // ç§»é™¤ç¾æœ‰çš„ selectï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        const existingSelect = input.parentNode.querySelector('select.batch-select');
        if (existingSelect) {
          input.parentNode.removeChild(existingSelect);
        }
        
        input.type = 'text';
        input.value = value || '';
        input.readOnly = readonly;
        input.disabled = false;
        input.style.display = 'block';
        input.className = input.className.replace(' batch-select', '');
        
        // æ ¹æ“šå€¼è¨­å®šè¦–è¦ºæ•ˆæœ
        if (!value) {
          // ç©ºå€¼ï¼šæ¢å¾©æ­£å¸¸æ¨£å¼
          input.style.background = '#0f1115';
          input.style.border = '1px solid #2b313b';
          input.style.color = '#e8eaed';
        } else if (value.includes('æŸ¥ç„¡æ‰¹è™Ÿ') || value.includes('æŸ¥è©¢å¤±æ•—')) {
          // éŒ¯èª¤ç‹€æ…‹ï¼šç´…è‰²è­¦å‘Šæ¨£å¼
          input.style.background = '#ffebee';
          input.style.border = '2px solid #f44336';
          input.style.color = '#d32f2f';
          if (value.includes('æŸ¥ç„¡æ‰¹è™Ÿ')) {
            input.value = 'â— æŸ¥ç„¡æ‰¹è™Ÿ';
          } else {
            input.value = 'âŒ æŸ¥è©¢å¤±æ•—';
          }
        } else {
          // æˆåŠŸç‹€æ…‹ï¼šç¶ è‰²æˆåŠŸæ¨£å¼
          input.style.background = '#e8f5e8';
          input.style.border = '2px solid #4caf50';
          input.style.color = '#2e7d32';
        }
      }

      // è¨­å®šæ‰¹è™Ÿç‚ºä¸‹æ‹‰é¸å–®
      function setBatchAsSelect(input, batches) {
        // éš±è—åŸæœ¬çš„ input
        input.style.display = 'none';
        
        // ç§»é™¤ç¾æœ‰çš„ selectï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        const existingSelect = input.parentNode.querySelector('select.batch-select');
        if (existingSelect) {
          input.parentNode.removeChild(existingSelect);
        }
        
        // å»ºç«‹æ–°çš„ select
        const select = document.createElement('select');
        select.className = 'batch-select';
        select.style.width = '100%';
        select.style.padding = '10px 12px';
        select.style.borderRadius = '8px';
        select.style.border = '1px solid #2b313b';
        select.style.background = '#0f1115';
        select.style.color = '#e8eaed';
        
        // åŠ å…¥æç¤ºé¸é …
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'è«‹é¸æ“‡æ‰¹è™Ÿ';
        placeholder.disabled = true;
        placeholder.selected = true;
        select.appendChild(placeholder);
        
        // åŠ å…¥æ‰¹è™Ÿé¸é …
        batches.forEach(batch => {
          const option = document.createElement('option');
          option.value = batch;
          option.textContent = batch;
          select.appendChild(option);
        });
        
        // ç¶å®šè®Šæ›´äº‹ä»¶
        select.addEventListener('change', function() {
          if (this.value) {
            setStatus('æ‰¹è™Ÿå·²é¸æ“‡', 'success');
          }
        });
        
        // æ’å…¥åˆ° input å¾Œé¢
        input.parentNode.insertBefore(select, input.nextSibling);
      }

      // ç‹€æ…‹é¡¯ç¤ºå‡½æ•¸
      function setStatus(message, type = 'info') {
        const statusDiv = document.getElementById('status');
        if (statusDiv) {
          statusDiv.textContent = message || '';
          statusDiv.className = `status ${type}`;
        }
      }

      // é€£ç·šæ¸¬è©¦ï¼ˆå¯éœé»˜ï¼‰
      async function pingService(silent = true) {
        try {
          const gasUrl = document.getElementById('gasUrl').value.trim();
          if (!gasUrl) {
            if (!silent) setStatus('è«‹å…ˆè¨­å®š Apps Script æœå‹™ç¶²å€', 'error');
            return false;
          }
          if (!silent) setStatus('æ¸¬è©¦é€£ç·šä¸­...', 'info');
          const res = await fetch(gasUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
            body: JSON.stringify({ action: 'ping' }),
          });
          const data = await res.json();
          if (data && data.ok) {
            if (!silent) setStatus('é€£ç·šæ­£å¸¸', 'success');
            return true;
          }
          if (!silent) setStatus('é€£ç·šå¤±æ•—', 'error');
          return false;
        } catch (e) {
          if (!silent) setStatus('é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèªéƒ¨ç½²èˆ‡æ¬Šé™', 'error');
          return false;
        }
      }

      // å•Ÿå‹• QR æƒæå™¨
      async function startBarcodeScanner() {
        try {
          const video = document.getElementById('video');
          if (!video) {
            setStatus('æ‰¾ä¸åˆ°ç›¸æ©Ÿå…ƒç´ ', 'error');
            return;
          }

          // æª¢æŸ¥ QR Scanner æ˜¯å¦è¼‰å…¥
          if (typeof QrScanner === 'undefined') {
            setStatus('QR æƒæå™¨è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
            return;
          }

          // åœæ­¢ç¾æœ‰çš„æƒæå™¨
          if (qrScanner) {
            qrScanner.stop();
            qrScanner.destroy();
          }

          // è‡ªå‹•å„ªåŒ–ç›¸æ©Ÿè¨­å®šï¼Œæ”¯æ´è¶…é è·é›¢QRæƒæ
          const constraints = {
            video: {
              width: { ideal: 4096 }, // 4K+è§£æåº¦ï¼Œæ”¯æ´è¶…é è·é›¢è­˜åˆ¥
              height: { ideal: 2304 },
              facingMode: 'environment', // ä½¿ç”¨å¾Œç½®é¡å¤´
              focusMode: 'continuous', // é€£çºŒè‡ªå‹•å°ç„¦
              focusDistance: { min: 0.1, max: 100.0 }, // æ¥µå¤§å°ç„¦ç¯„åœï¼Œæ”¯æ´è¶…é è·é›¢
              advanced: [
                { focusMode: 'continuous' },
                { focusDistance: { min: 0.1, max: 100.0 } },
                { exposureMode: 'continuous' }, // é€£çºŒæ›å…‰èª¿æ•´
                { whiteBalanceMode: 'continuous' }, // é€£çºŒç™½å¹³è¡¡èª¿æ•´
                { zoom: { min: 1.0, max: 8.0 } }, // æ”¯æ´æ¥µé«˜å€æ•¸è®Šç„¦
                { torch: false }, // é—œé–‰é–ƒå…‰ç‡ˆï¼Œé¿å…å¹²æ“¾
                { iso: { min: 100, max: 3200 } }, // å¢åŠ ISOç¯„åœ
                { brightness: { min: -1.0, max: 1.0 } }, // äº®åº¦èª¿æ•´
                { contrast: { min: 0.0, max: 2.0 } }, // å°æ¯”åº¦èª¿æ•´
                { saturation: { min: 0.0, max: 2.0 } } // é£½å’Œåº¦èª¿æ•´
              ]
            }
          };

          // å»ºç«‹æ–°çš„ QR æƒæå™¨ï¼Œæ”¯æ´å¤šQRç¢¼è­˜åˆ¥å’Œé è·é›¢æƒæ
          qrScanner = new QrScanner(
            video,
            result => {
              handleQRResult(result);
            },
            {
              onDecodeError: (error) => {
                // è§£ç¢¼éŒ¯èª¤æ˜¯æ­£å¸¸çš„ï¼Œä¸éœ€è¦é¡¯ç¤º
                console.debug('QR è§£ç¢¼éŒ¯èª¤:', error);
              },
              highlightScanRegion: false, // é—œé–‰æƒæå€åŸŸé«˜äº®ï¼Œé¿å…å¹²æ“¾å¤šQRç¢¼è­˜åˆ¥
              highlightCodeOutline: true, // ä¿ç•™QRç¢¼é‚Šæ¡†é«˜äº®
              preferredCamera: 'environment', // å„ªå…ˆä½¿ç”¨å¾Œç½®é¡é ­
              maxScansPerSecond: 100, // è¶…é«˜æƒæé »ç‡ï¼Œæ¥µé€Ÿè­˜åˆ¥å¤šQRç¢¼
              calculateScanRegion: function(video) {
                // ä½¿ç”¨å…¨ç•«é¢æƒæï¼Œæ”¯æ´å¤šQRç¢¼è­˜åˆ¥å’Œè¶…é è·é›¢æƒæ
                return {
                  x: 0,
                  y: 0,
                  width: video.videoWidth,
                  height: video.videoHeight
                };
              },
              // å„ªåŒ–æƒæåƒæ•¸ï¼Œæ”¯æ´è¶…é è·é›¢è­˜åˆ¥
              preferredResolution: { width: 4096, height: 2304 },
              // å¤šQRç¢¼å¿«é€Ÿè­˜åˆ¥å„ªåŒ–
              qrCodeDetector: {
                minFeatureSize: 0.5, // è¶…ä½æœ€å°ç‰¹å¾µå°ºå¯¸ï¼Œæ¥µé«˜éˆæ•åº¦
                maxNumberOfFeatures: 50000, // è¶…é«˜æœ€å¤§ç‰¹å¾µæ•¸é‡
                scanInterval: 5, // è¶…ä½æƒæé–“éš”ï¼Œæ¥µé€ŸéŸ¿æ‡‰
                minQRCodeSize: 3, // æ”¯æ´æ¥µå°QRç¢¼è­˜åˆ¥
                detectionThreshold: 0.01, // è¶…ä½æª¢æ¸¬é–¾å€¼ï¼Œæ¥µé«˜éˆæ•åº¦
                rotationTolerance: 180, // æ”¯æ´ä»»æ„è§’åº¦æ—‹è½‰
                blurTolerance: 0.95, // è¶…é«˜æ¨¡ç³Šå®¹å¿åº¦
                // å¤šQRç¢¼å„ªåŒ–
                multiQRDetection: true, // å•Ÿç”¨å¤šQRç¢¼æª¢æ¸¬
                parallelProcessing: true, // ä¸¦è¡Œè™•ç†
                // æ¥µé€Ÿè­˜åˆ¥å„ªåŒ–
                fastMode: true, // å¿«é€Ÿæ¨¡å¼
                skipValidation: false, // ä¿æŒé©—è­‰
                // åœ–åƒè™•ç†å„ªåŒ–
                imageEnhancement: true,
                contrastBoost: 1.5,
                brightnessAdjust: 0.2,
                // æ–°å¢éˆæ•åº¦å„ªåŒ–
                edgeDetection: true, // é‚Šç·£æª¢æ¸¬
                noiseReduction: false, // é—œé–‰é™å™ªä»¥ä¿æŒç´°ç¯€
                sharpening: true, // éŠ³åŒ–è™•ç†
                adaptiveThreshold: true // è‡ªé©æ‡‰é–¾å€¼
              }
            }
          );

          // å•Ÿå‹•æƒæå™¨
          await qrScanner.start();
          
          // åˆå§‹åŒ–ARæ¨™è¨˜ç³»çµ±
          await initARMarkers();
          console.log('ARæ¨™è¨˜ç³»çµ±å·²åˆå§‹åŒ–');
          
          // è‡ªå‹•å°ç„¦å„ªåŒ–
          await optimizeAutoFocus();
          
          // é‡ç½®æƒæçµ±è¨ˆ
          scanStats = {
            totalScanned: 0,
            startTime: Date.now(),
            lastScanTime: null
          };
          
          // åˆå§‹åŒ–è¨ˆæ•¸å™¨é¡¯ç¤º
          updateQRCounter();
          
          // å•Ÿç”¨/åœç”¨æŒ‰éˆ•
          document.getElementById('startScan').disabled = true;
          document.getElementById('stopScan').disabled = false;
          
          setStatus('QR æƒæå™¨å·²å•Ÿå‹•ï¼Œæ”¯æ´è¶…é è·é›¢å¤šQRç¢¼åŒæ™‚è­˜åˆ¥ï¼Œè«‹å°‡QRç¢¼å°æº–é¡é ­', 'success');
          
        } catch (error) {
          console.error('å•Ÿå‹• QR æƒæå™¨å¤±æ•—:', error);
          setStatus('ç„¡æ³•å•Ÿå‹• QR æƒæå™¨ï¼Œè«‹ç¢ºèªç›¸æ©Ÿæ¬Šé™', 'error');
        }
      }

      // è™•ç† QR æƒæçµæœï¼ˆæ”¯æ´å¤šQRç¢¼è­˜åˆ¥ï¼‰
      function handleQRResult(result) {
        const qrText = result.data;
        
        // èª¿è©¦ï¼šé¡¯ç¤ºå¯¦éš›æƒæåˆ°çš„å…§å®¹
        console.log('æƒæåˆ°çš„QRç¢¼å…§å®¹:', qrText);
        
        // é©—è­‰QRç¢¼æ ¼å¼ï¼šå¿…é ˆæ˜¯ https://jerosse.com.tw/ é–‹é ­ä¸”å¾Œé¢æœ‰æ•¸å­—
        const jerossePattern = /^https:\/\/jerosse\.com\.tw\/(\d+)$/;
        const match = qrText.match(jerossePattern);
        
        if (!match) {
          console.log(`QRç¢¼æ ¼å¼ä¸ç¬¦: "${qrText}"`);
          scanAttempts++;
          // å¦‚æœé€£çºŒæƒæå¤±æ•—ï¼Œé¡¯ç¤ºæç¤º
          if (scanAttempts > 5) {
            showScanningTips();
            scanAttempts = 0; // é‡ç½®è¨ˆæ•¸å™¨
          }
          return; // éœé»˜å¿½ç•¥ç„¡æ•ˆQRç¢¼ï¼Œé¿å…å¹²æ“¾å¤šQRç¢¼æƒæ
        }
        
        // æå–æ•¸å­—éƒ¨åˆ†ï¼ˆä¿æŒå®Œæ•´æ ¼å¼ï¼ŒåŒ…æ‹¬å‰å°0ï¼‰
        const qrNumber = match[1];
        
        // æª¢æŸ¥æ˜¯å¦å·²æƒæéï¼ˆä½¿ç”¨å®Œæ•´æ•¸å­—ä½œç‚ºå”¯ä¸€è­˜åˆ¥ï¼‰
        if (scannedQRs.has(qrNumber)) {
          console.log(`QRç¢¼å·²å­˜åœ¨: ${qrNumber}`);
          return; // éœé»˜å¿½ç•¥é‡è¤‡QRç¢¼
        }

        // æˆåŠŸæƒæï¼Œé‡ç½®è¨ˆæ•¸å™¨
        scanAttempts = 0;
        lastScanTime = Date.now();

        // è¨˜éŒ„å·²æƒæçš„ QR ç¢¼ï¼ˆä½¿ç”¨å®Œæ•´æ•¸å­—ï¼‰
        scannedQRs.add(qrNumber);
        
        // æ›´æ–°æƒæçµ±è¨ˆ
        updateScanStats();
        
        // æ™ºèƒ½å°ç„¦åˆ°QRç¢¼ä½ç½®ï¼ˆå¤šQRç¢¼æ¨¡å¼è‡ªå‹•å•Ÿç”¨ï¼‰
        if (multiScanMode) {
          autoFocusToQR(result);
        }
        
        // æ·»åŠ ARæ¨™è¨˜ï¼ˆå³ä½¿æ²’æœ‰locationè³‡è¨Šä¹Ÿå˜—è©¦æ·»åŠ ï¼‰
        console.log('QRæƒæçµæœ:', result);
        
        if (result.location) {
          // æœ‰ä½ç½®è³‡è¨Šï¼Œä½¿ç”¨ç²¾ç¢ºä½ç½®
          const qrLocation = result.location;
          const position = {
            x: Math.min(qrLocation.topLeftCorner.x, qrLocation.bottomLeftCorner.x),
            y: Math.min(qrLocation.topLeftCorner.y, qrLocation.topRightCorner.y)
          };
          const size = {
            width: Math.abs(qrLocation.topRightCorner.x - qrLocation.topLeftCorner.x),
            height: Math.abs(qrLocation.bottomLeftCorner.y - qrLocation.topLeftCorner.y)
          };
          addARMarker(qrNumber, position, size);
        } else {
          // æ²’æœ‰ä½ç½®è³‡è¨Šï¼Œåœ¨ç›¸æ©Ÿç•«é¢ä¸­å¤®æ·»åŠ ARæ¨™è¨˜
          console.log('æ²’æœ‰QRç¢¼ä½ç½®è³‡è¨Šï¼Œåœ¨ä¸­å¤®æ·»åŠ ARæ¨™è¨˜');
          const video = document.getElementById('video');
          if (video) {
            const videoRect = video.getBoundingClientRect();
            const position = {
              x: videoRect.width / 2,
              y: videoRect.height / 2
            };
            const size = {
              width: 100,
              height: 100
            };
            addARMarker(qrNumber, position, size);
          }
        }
        
        // æ›´æ–° QR å…§å®¹æ¬„ä½
        const qrInput = document.getElementById('qrText');
        if (batchMode) {
          // æ‰¹é‡æ¨¡å¼ï¼šé¡¯ç¤ºæ‰€æœ‰QRç¢¼ï¼Œç”¨é€—è™Ÿåˆ†éš”
          qrInput.value = Array.from(scannedQRs).join(', ');
        } else {
          // å–®ä¸€æ¨¡å¼ï¼šåªé¡¯ç¤ºç•¶å‰QRç¢¼
          qrInput.value = qrNumber;
        }
        
        // æ›´æ–°æƒæè¨˜éŒ„é¡¯ç¤º
        updateScannedList();
        
        // å³æ™‚æ›´æ–°ç‹€æ…‹é¡¯ç¤º
        setStatus(`âœ… å·²è­˜åˆ¥ ${scannedQRs.size} å€‹QRç¢¼ï¼ŒæŒçºŒæƒæä¸­...`, 'success');
        
        // éœ‡å‹•æç¤ºï¼ˆå¦‚æœæ”¯æ´ï¼‰
        if (navigator.vibrate) {
          navigator.vibrate(100); // çŸ­éœ‡å‹•ï¼Œé¿å…å¹²æ“¾é€£çºŒæƒæ
        }
        
        // ä½¿ç”¨åŸç”ŸAPIæ¨™è¨˜å·²æƒæçš„QRç¢¼ï¼ˆARåŠŸèƒ½ï¼‰
        markQRCodeAsScanned(result);
      }

      // ARæ¨™è¨˜ç®¡ç†å™¨
      let arSession = null;
      let arMarkers = new Map(); // å„²å­˜ARæ¨™è¨˜ä½ç½®
      let isARSupported = false;

      // åˆå§‹åŒ–ARåŠŸèƒ½ï¼ˆè‡ªå‹•å•Ÿç”¨ï¼‰
      async function initAR() {
        try {
          if ('xr' in navigator) {
            isARSupported = await navigator.xr.isSessionSupported('immersive-ar');
            if (isARSupported) {
              console.log('ARåŠŸèƒ½å·²è‡ªå‹•å•Ÿç”¨');
              setStatus('ARæ¨™è¨˜åŠŸèƒ½å·²è‡ªå‹•å•Ÿç”¨', 'success');
              // è‡ªå‹•å•Ÿå‹•ARæœƒè©±
              await startARSession();
            } else {
              console.log('ARåŠŸèƒ½ä¸æ”¯æ´ï¼Œä½¿ç”¨Canvasæ¨™è¨˜');
              setStatus('Canvasæ¨™è¨˜åŠŸèƒ½å·²å•Ÿç”¨', 'info');
            }
          } else {
            console.log('WebXRä¸æ”¯æ´ï¼Œä½¿ç”¨Canvasæ¨™è¨˜');
            setStatus('Canvasæ¨™è¨˜åŠŸèƒ½å·²å•Ÿç”¨', 'info');
          }
        } catch (error) {
          console.log('ARåˆå§‹åŒ–å¤±æ•—ï¼Œä½¿ç”¨Canvasæ¨™è¨˜:', error);
          setStatus('Canvasæ¨™è¨˜åŠŸèƒ½å·²å•Ÿç”¨', 'info');
        }
      }

      // ä½¿ç”¨åŸç”ŸAPIæ¨™è¨˜å·²æƒæçš„QRç¢¼ï¼ˆç›´æ¥åœ¨æƒæç•«é¢è¦†è“‹ï¼‰
      async function markQRCodeAsScanned(result) {
        try {
          const qrText = result.data;
          const jerossePattern = /^https:\/\/jerosse\.com\.tw\/(\d+)$/;
          const match = qrText.match(jerossePattern);
          
          if (!match) return;
          
          const qrNumber = match[1];
          
          // ç›´æ¥åœ¨æƒæç•«é¢ä¸­è¦†è“‹æ¨™è¨˜ï¼ˆä¸ä¾è³´ARæœƒè©±ï¼‰
          createCanvasMarker(result, qrNumber);
          
          // å¦‚æœARåŠŸèƒ½å¯ç”¨ï¼Œä¹Ÿå‰µå»ºARæ¨™è¨˜
          if (isARSupported && arSession) {
            await createARMarker(result, qrNumber);
          }
        } catch (error) {
          console.log('æ¨™è¨˜åŠŸèƒ½éŒ¯èª¤:', error);
          // é™ç´šåˆ°Canvasæ¨™è¨˜
          createCanvasMarker(result, qrNumber);
        }
      }

      // å‰µå»ºARæ¨™è¨˜ï¼ˆWebXRï¼‰
      async function createARMarker(result, qrNumber) {
        try {
          if (!arSession) {
            // å•Ÿå‹•ARæœƒè©±
            arSession = await navigator.xr.requestSession('immersive-ar', {
              requiredFeatures: ['local'],
              optionalFeatures: ['hit-test']
            });
            
            // è¨­å®šARæœƒè©±äº‹ä»¶
            arSession.addEventListener('end', () => {
              arSession = null;
              arMarkers.clear();
            });
          }

          // ç²å–QRç¢¼åœ¨3Dç©ºé–“ä¸­çš„ä½ç½®
          const qrPosition = await getQRCode3DPosition(result);
          
          if (qrPosition) {
            // å‰µå»ºARæ¨™è¨˜
            const marker = {
              id: qrNumber,
              position: qrPosition,
              timestamp: Date.now(),
              element: createARMarkerElement(qrNumber)
            };
            
            arMarkers.set(qrNumber, marker);
            console.log(`ARæ¨™è¨˜å·²å‰µå»º: ${qrNumber}`);
          }
        } catch (error) {
          console.error('å‰µå»ºARæ¨™è¨˜å¤±æ•—:', error);
        }
      }

      // ç²å–QRç¢¼åœ¨3Dç©ºé–“ä¸­çš„ä½ç½®
      async function getQRCode3DPosition(result) {
        try {
          // ä½¿ç”¨WebXRçš„hit-teståŠŸèƒ½
          const referenceSpace = await arSession.requestReferenceSpace('local');
          const hitTestSource = await arSession.requestHitTestSource({ space: referenceSpace });
          
          // å°‡QRç¢¼çš„2Dä½ç½®è½‰æ›ç‚º3Dä½ç½®
          const qrRect = result.location;
          const x = (qrRect.x + qrRect.width / 2) / window.innerWidth;
          const y = (qrRect.y + qrRect.height / 2) / window.innerHeight;
          
          // å‰µå»ºå°„ç·šé€²è¡Œhit-test
          const ray = new XRRay(
            new DOMPoint(0, 0, 0),
            new DOMPoint(x - 0.5, y - 0.5, -1)
          );
          
          const hitTestResults = await hitTestSource.requestHitTest(ray, referenceSpace);
          
          if (hitTestResults.length > 0) {
            return hitTestResults[0].hitMatrix;
          }
        } catch (error) {
          console.error('ç²å–3Dä½ç½®å¤±æ•—:', error);
        }
        return null;
      }

      // å‰µå»ºARæ¨™è¨˜å…ƒç´ 
      function createARMarkerElement(qrNumber) {
        const marker = document.createElement('div');
        marker.className = 'ar-marker';
        marker.innerHTML = `
          <div class="ar-marker-circle">
            <div class="ar-marker-check">âœ“</div>
            <div class="ar-marker-number">${qrNumber}</div>
          </div>
        `;
        marker.style.cssText = `
          position: absolute;
          width: 60px;
          height: 60px;
          pointer-events: none;
          z-index: 1000;
        `;
        return marker;
      }

      // å‰µå»ºCanvasæ¨™è¨˜ï¼ˆç›´æ¥åœ¨æƒæç•«é¢è¦†è“‹ï¼‰
      function createCanvasMarker(result, qrNumber) {
        const canvas = document.getElementById('overlay');
        if (canvas && result.location) {
          const ctx = canvas.getContext('2d');
          const rect = result.location;
          
          // å„²å­˜æ¨™è¨˜ä½ç½®ä¿¡æ¯ï¼ˆç”¨æ–¼æŒä¹…åŒ–ï¼‰
          const markerInfo = {
            qrNumber: qrNumber,
            x: rect.x,
            y: rect.y,
            width: rect.width,
            height: rect.height,
            timestamp: Date.now()
          };
          
          // å„²å­˜åˆ°æœ¬åœ°å­˜å„²
          let markers = JSON.parse(localStorage.getItem('arMarkers') || '[]');
          markers.push(markerInfo);
          localStorage.setItem('arMarkers', JSON.stringify(markers));
          
          // ç¹ªè£½æ¨™è¨˜
          drawMarkerOnCanvas(markerInfo);
          
          console.log(`Canvasæ¨™è¨˜å·²å‰µå»ºä¸¦å›ºå®š: ${qrNumber}`);
        }
      }
      
      // åœ¨Canvasä¸Šç¹ªè£½æ¨™è¨˜
      function drawMarkerOnCanvas(markerInfo) {
        const canvas = document.getElementById('overlay');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const { x, y, width, height, qrNumber } = markerInfo;
        
        // ç¹ªè£½åŠé€æ˜èƒŒæ™¯è¦†è“‹æ•´å€‹QRç¢¼
        ctx.fillStyle = 'rgba(255, 152, 0, 0.4)';
        ctx.fillRect(x, y, width, height);
        
        // ç¹ªè£½æ©™è‰²åœ“åœˆæ¨™è¨˜ï¼ˆé¡ä¼¼åœ–ä¸­çš„æ¨™è¨˜ï¼‰
        ctx.strokeStyle = '#FF9800';
        ctx.fillStyle = 'rgba(255, 152, 0, 0.2)';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.arc(x + width/2, y + height/2, Math.max(width, height)/2 + 10, 0, 2 * Math.PI);
        ctx.fill();
        ctx.stroke();
        
        // ç¹ªè£½"âœ“"æ¨™è¨˜
        ctx.fillStyle = '#FF9800';
        ctx.font = 'bold 28px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('âœ“', x + width/2, y + height/2 + 10);
        
        // ç¹ªè£½QRç¢¼ç·¨è™Ÿ
        ctx.font = 'bold 14px Arial';
        ctx.fillText(qrNumber, x + width/2, y + height/2 + 30);
      }

      // å•Ÿå‹•ARæœƒè©±ï¼ˆè‡ªå‹•å•Ÿå‹•ï¼‰
      async function startARSession() {
        try {
          if (isARSupported) {
            arSession = await navigator.xr.requestSession('immersive-ar', {
              requiredFeatures: ['local'],
              optionalFeatures: ['hit-test']
            });
            console.log('ARæœƒè©±å·²è‡ªå‹•å•Ÿå‹•');
            return true;
          } else {
            console.log('ARåŠŸèƒ½ä¸æ”¯æ´ï¼Œä½¿ç”¨Canvasæ¨™è¨˜');
            return false;
          }
        } catch (error) {
          console.error('å•Ÿå‹•ARæœƒè©±å¤±æ•—ï¼Œä½¿ç”¨Canvasæ¨™è¨˜:', error);
          return false;
        }
      }

      // åœæ­¢ARæœƒè©±
      function stopARSession() {
        if (arSession) {
          arSession.end();
          arSession = null;
          arMarkers.clear();
          setStatus('ARæœƒè©±å·²åœæ­¢', 'info');
        }
      }

      // æ¸…é™¤æ‰€æœ‰æ¨™è¨˜
      function clearAllMarkers() {
        // æ¸…é™¤Canvasæ¨™è¨˜
        const canvas = document.getElementById('overlay');
        if (canvas) {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        // æ¸…é™¤ARæ¨™è¨˜
        clearARMarkers();
        
        // æ¸…é™¤æœ¬åœ°å­˜å„²çš„æ¨™è¨˜
        localStorage.removeItem('arMarkers');
        
        setStatus('æ‰€æœ‰æ¨™è¨˜å·²æ¸…é™¤', 'info');
      }
      
      // æ¢å¾©ä¹‹å‰ä¿å­˜çš„æ¨™è¨˜
      function restoreMarkers() {
        try {
          const savedMarkers = JSON.parse(localStorage.getItem('arMarkers') || '[]');
          if (savedMarkers.length > 0) {
            console.log(`æ¢å¾© ${savedMarkers.length} å€‹æ¨™è¨˜`);
            savedMarkers.forEach(marker => {
              drawMarkerOnCanvas(marker);
            });
            setStatus(`å·²æ¢å¾© ${savedMarkers.length} å€‹æ¨™è¨˜`, 'info');
          }
        } catch (error) {
          console.error('æ¢å¾©æ¨™è¨˜å¤±æ•—:', error);
        }
      }

      // æ›´æ–°æƒæè¨˜éŒ„åˆ—è¡¨
      function updateScannedList() {
        const listContainer = document.getElementById('scannedList');
        if (!listContainer) return;

        listContainer.innerHTML = '';
        
        if (scannedQRs.size === 0) {
          listContainer.innerHTML = '<p class="small">å°šæœªæƒæä»»ä½• QR ç¢¼</p>';
          return;
        }

        const title = document.createElement('h4');
        title.textContent = `å·²æƒæ ${scannedQRs.size} å€‹ QR ç¢¼ï¼š`;
        listContainer.appendChild(title);

        scannedQRs.forEach((qrNumber, index) => {
          const item = document.createElement('div');
          item.className = 'scanned-item';
          item.innerHTML = `
            <span class="qr-number">${index + 1}.</span>
            <span class="qr-content">https://jerosse.com.tw/${qrNumber}</span>
            <button class="remove-btn" onclick="removeQR('${qrNumber}')">Ã—</button>
          `;
          listContainer.appendChild(item);
        });
      }

      // ç§»é™¤ QR ç¢¼
      function removeQR(qrNumber) {
        scannedQRs.delete(qrNumber);
        updateScannedList();
        
        // å¦‚æœç§»é™¤çš„æ˜¯ç•¶å‰ QR å…§å®¹ï¼Œæ¸…ç©ºæ¬„ä½
        if (document.getElementById('qrText').value === qrNumber) {
          document.getElementById('qrText').value = '';
        }
        
        // æ›´æ–°é¡é ­ç•«é¢ä¸Šçš„è¨ˆæ•¸å™¨
        updateQRCounter();
        
        setStatus(`å·²ç§»é™¤ QR ç¢¼ï¼Œå‰©é¤˜ ${scannedQRs.size} å€‹`, 'info');
      }

      // æ¸…ç©ºæ‰€æœ‰æƒæè¨˜éŒ„
      function clearAllQRs() {
        scannedQRs.clear();
        clearARMarkers(); // æ¸…é™¤ARæ¨™è¨˜
        document.getElementById('qrText').value = '';
        updateScannedList();
        
        // é‡ç½®çµ±è¨ˆæ•¸æ“š
        scanStats = {
          totalScanned: 0,
          startTime: null,
          lastScanTime: null
        };
        
        // éš±è—çµ±è¨ˆé¢æ¿
        const batchStatsEl = document.getElementById('batchStats');
        if (batchStatsEl) {
          batchStatsEl.style.display = 'none';
        }
        
        // é‡ç½®é¡é ­ç•«é¢ä¸Šçš„è¨ˆæ•¸å™¨
        updateQRCounter();
        
        setStatus('å·²æ¸…ç©ºæ‰€æœ‰æƒæè¨˜éŒ„', 'info');
      }

      // åœæ­¢æƒæ
      function stopBarcodeScanner() {
        if (qrScanner) {
          qrScanner.stop();
          qrScanner.destroy();
          qrScanner = null;
        }
        
        // å•Ÿç”¨/åœç”¨æŒ‰éˆ•
        document.getElementById('startScan').disabled = false;
        document.getElementById('stopScan').disabled = true;
        
        setStatus('QR æƒæå™¨å·²åœæ­¢ï¼Œå·²æƒæçš„æ¨™è¨˜ä»æœƒé¡¯ç¤º', 'info');
      }

      // æ›´æ–°æƒæçµ±è¨ˆ
      function updateScanStats() {
        const now = Date.now();
        
        // åˆå§‹åŒ–çµ±è¨ˆæ™‚é–“
        if (!scanStats.startTime) {
          scanStats.startTime = now;
        }
        
        scanStats.totalScanned++;
        scanStats.lastScanTime = now;
        
        // æ›´æ–°çµ±è¨ˆé¡¯ç¤º
        const totalScannedEl = document.getElementById('totalScanned');
        const scanningSpeedEl = document.getElementById('scanningSpeed');
        const uniqueCodesEl = document.getElementById('uniqueCodes');
        const batchStatsEl = document.getElementById('batchStats');
        
        if (totalScannedEl) totalScannedEl.textContent = scanStats.totalScanned;
        if (uniqueCodesEl) uniqueCodesEl.textContent = scannedQRs.size;
        
        // è¨ˆç®—æƒæé€Ÿåº¦
        if (scanningSpeedEl && scanStats.startTime) {
          const elapsedSeconds = (now - scanStats.startTime) / 1000;
          const speed = elapsedSeconds > 0 ? (scanStats.totalScanned / elapsedSeconds).toFixed(1) : 0;
          scanningSpeedEl.textContent = speed;
        }
        
        // é¡¯ç¤ºçµ±è¨ˆé¢æ¿
        if (batchStatsEl && scanStats.totalScanned > 0) {
          batchStatsEl.style.display = 'block';
        }
        
        // æ›´æ–°é¡é ­ç•«é¢ä¸Šçš„è¨ˆæ•¸å™¨
        updateQRCounter();
      }
      
      // æ›´æ–°é¡é ­ç•«é¢ä¸Šçš„QRç¢¼è¨ˆæ•¸å™¨
      function updateQRCounter() {
        const counterNumber = document.getElementById('counterNumber');
        const qrCounter = document.getElementById('qrCounter');
        
        if (counterNumber && qrCounter) {
          const count = scannedQRs.size;
          
          // æ›´æ–°æ•¸å­—
          counterNumber.textContent = count;
          
          // å¦‚æœæœ‰æƒæåˆ°QRç¢¼ï¼Œé¡¯ç¤ºè¨ˆæ•¸å™¨ä¸¦æ·»åŠ å‹•ç•«
          if (count > 0) {
            qrCounter.style.display = 'block';
            counterNumber.classList.add('updated');
            
            // ç§»é™¤å‹•ç•«é¡åˆ¥
            setTimeout(() => {
              counterNumber.classList.remove('updated');
            }, 500);
          } else {
            // æ²’æœ‰QRç¢¼æ™‚éš±è—è¨ˆæ•¸å™¨
            qrCounter.style.display = 'none';
          }
        }
      }

      // è‡ªå‹•å°ç„¦åˆ°QRç¢¼ä½ç½®
      async function autoFocusToQR(result) {
        if (!result || !result.location) return;
        
        try {
          const stream = video.srcObject;
          if (!stream) return;

          const track = stream.getVideoTracks()[0];
          if (!track) return;

          // ç²å–QRç¢¼åœ¨ç•«é¢ä¸­çš„ä½ç½®
          const qrLocation = result.location;
          const videoRect = video.getBoundingClientRect();
          
          // è¨ˆç®—QRç¢¼ä¸­å¿ƒé»
          const centerX = (qrLocation.topLeftCorner.x + qrLocation.topRightCorner.x + 
                          qrLocation.bottomLeftCorner.x + qrLocation.bottomRightCorner.x) / 4;
          const centerY = (qrLocation.topLeftCorner.y + qrLocation.topRightCorner.y + 
                          qrLocation.bottomLeftCorner.y + qrLocation.bottomRightCorner.y) / 4;
          
          // è¨ˆç®—QRç¢¼å¤§å°
          const qrWidth = Math.abs(qrLocation.topRightCorner.x - qrLocation.topLeftCorner.x);
          const qrHeight = Math.abs(qrLocation.bottomLeftCorner.y - qrLocation.topLeftCorner.y);
          const qrSize = Math.max(qrWidth, qrHeight);
          
          // æ ¹æ“šQRç¢¼å¤§å°èª¿æ•´å°ç„¦è·é›¢ï¼ˆå„ªåŒ–é è·é›¢ï¼‰
          let focusDistance;
          if (qrSize < 30) {
            focusDistance = { min: 0.1, max: 0.5 }; // æ¥µè¿‘è·é›¢
          } else if (qrSize < 60) {
            focusDistance = { min: 0.3, max: 2.0 }; // è¿‘è·é›¢
          } else if (qrSize < 120) {
            focusDistance = { min: 1.0, max: 5.0 }; // ä¸­è·é›¢
          } else if (qrSize < 200) {
            focusDistance = { min: 2.0, max: 15.0 }; // é è·é›¢
          } else {
            focusDistance = { min: 5.0, max: 50.0 }; // è¶…é è·é›¢
          }
          
          // æ‡‰ç”¨å°ç„¦è¨­å®š
          await track.applyConstraints({
            focusMode: 'continuous',
            focusDistance: focusDistance,
            pointsOfInterest: [{ x: centerX / videoRect.width, y: centerY / videoRect.height }]
          });
          
          console.log(`è‡ªå‹•å°ç„¦åˆ°QRç¢¼ä½ç½®: (${centerX}, ${centerY}), å¤§å°: ${qrSize}`);
          
        } catch (error) {
          console.log('è‡ªå‹•å°ç„¦å¤±æ•—:', error);
        }
      }

      // æ ¹æ“šQRç¢¼å¤§å°å‹•æ…‹èª¿æ•´å°ç„¦
      async function adjustFocusByQRSize(result) {
        try {
          if (!result.location) return;
          
          const stream = video.srcObject;
          if (!stream) return;
          
          const track = stream.getVideoTracks()[0];
          if (!track) return;
          
          const capabilities = track.getCapabilities();
          if (!capabilities.focusMode || !capabilities.focusDistance) return;
          
          // æ ¹æ“šQRç¢¼åœ¨ç•«é¢ä¸­çš„å¤§å°åˆ¤æ–·è·é›¢
          const qrArea = result.location.width * result.location.height;
          const screenArea = video.videoWidth * video.videoHeight;
          const qrRatio = qrArea / screenArea;
          
          let focusDistance;
          if (qrRatio > 0.1) {
            // QRç¢¼å¾ˆå¤§ï¼Œè¡¨ç¤ºå¾ˆè¿‘è·é›¢
            focusDistance = { min: 0.1, max: 0.5 };
          } else if (qrRatio > 0.05) {
            // QRç¢¼ä¸­ç­‰å¤§å°ï¼Œè¡¨ç¤ºä¸­ç­‰è·é›¢
            focusDistance = { min: 0.5, max: 2.0 };
          } else {
            // QRç¢¼å¾ˆå°ï¼Œè¡¨ç¤ºé è·é›¢
            focusDistance = { min: 2.0, max: 10.0 };
          }
          
          // æ‡‰ç”¨å°ç„¦èª¿æ•´
          await track.applyConstraints({
            focusMode: 'continuous',
            focusDistance: focusDistance
          });
          
          console.log(`æ ¹æ“šQRç¢¼å¤§å°èª¿æ•´å°ç„¦: ${JSON.stringify(focusDistance)}`);
          
        } catch (error) {
          console.log('å‹•æ…‹å°ç„¦èª¿æ•´å¤±æ•—:', error);
        }
      }

      // åˆå§‹åŒ–ARæ¨™è¨˜ç³»çµ±
      async function initARMarkers() {
        try {
          // åˆå§‹åŒ–å‚³çµ±ç•«å¸ƒ
          canvas = document.getElementById('arCanvas');
          if (canvas) {
            ctx = canvas.getContext('2d');
            resizeARCanvas();
            console.log('Canvas ARæ¨™è¨˜ç³»çµ±å·²åˆå§‹åŒ–');
          }
          
          // åˆå§‹åŒ–ARå ´æ™¯
          await initARScene();
          console.log('ARæ¨™è¨˜ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
          
        } catch (error) {
          console.error('ARæ¨™è¨˜ç³»çµ±åˆå§‹åŒ–å¤±æ•—:', error);
          setStatus('ARæ¨™è¨˜ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œå°‡ä½¿ç”¨Canvasæ¨™è¨˜', 'warning');
        }
      }

      // åˆå§‹åŒ–ARå ´æ™¯
      async function initARScene() {
        try {
          // å‰µå»ºARå ´æ™¯å®¹å™¨ï¼ˆç¸½æ˜¯å‰µå»ºï¼Œä¸ç®¡WebXRæ”¯æ´èˆ‡å¦ï¼‰
          const arContainer = document.createElement('div');
          arContainer.id = 'ar-container';
          arContainer.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 4;
          `;
          
          // æ·»åŠ åˆ°é è¦½å®¹å™¨
          const previewContainer = document.getElementById('preview-container');
          if (previewContainer) {
            previewContainer.appendChild(arContainer);
            arScene = arContainer; // ä½¿ç”¨å®¹å™¨æœ¬èº«ä½œç‚ºARå ´æ™¯
            console.log('ARå ´æ™¯å®¹å™¨å·²å‰µå»º');
          }
          
          // æª¢æŸ¥ä¸¦åˆå§‹åŒ–è˜‹æœåŸç”ŸWebXR AR
          await initNativeWebXR();
          
        } catch (error) {
          console.error('ARå ´æ™¯åˆå§‹åŒ–å¤±æ•—:', error);
          setStatus('ARå ´æ™¯åˆå§‹åŒ–å¤±æ•—', 'error');
        }
      }

      // åˆå§‹åŒ–è˜‹æœåŸç”ŸWebXR AR
      async function initNativeWebXR() {
        try {
          if ('xr' in navigator) {
            console.log('WebXR API å¯ç”¨');
            
            // æª¢æŸ¥ARæ”¯æ´
            const isSupported = await navigator.xr.isSessionSupported('immersive-ar');
            if (isSupported) {
              console.log('è˜‹æœåŸç”ŸWebXR AR æ”¯æ´');
              
              // å‰µå»ºWebXR ARæœƒè©±ï¼Œå•Ÿç”¨æ‰€æœ‰ARåŠŸèƒ½
              const session = await navigator.xr.requestSession('immersive-ar', {
                requiredFeatures: ['local', 'hit-test', 'anchors', 'plane-detection'],
                optionalFeatures: ['dom-overlay', 'light-estimation', 'depth-sensing', 'camera-access']
              });
              
              // åˆå§‹åŒ–ç¾å¯¦ä¸–ç•ŒARç³»çµ±
              await initRealWorldAR(session);
              
            } else {
              console.log('WebXR AR ä¸æ”¯æ´ï¼Œä½¿ç”¨Canvas AR');
            }
          } else {
            console.log('WebXR API ä¸å¯ç”¨ï¼Œä½¿ç”¨Canvas AR');
          }
        } catch (error) {
          console.error('WebXR AR åˆå§‹åŒ–å¤±æ•—:', error);
          setStatus('WebXR AR åˆå§‹åŒ–å¤±æ•—ï¼Œä½¿ç”¨Canvas AR', 'warning');
        }
      }

      // åˆå§‹åŒ–ç¾å¯¦ä¸–ç•ŒARç³»çµ±
      async function initRealWorldAR(session) {
        console.log('åˆå§‹åŒ–ç¾å¯¦ä¸–ç•ŒARç³»çµ±...');
        
        // å‰µå»ºWebXRæ¸²æŸ“å™¨
        const canvas = document.createElement('canvas');
        canvas.id = 'xr-canvas';
        canvas.style.cssText = `
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          z-index: 1001;
        `;
        
        // æ·»åŠ åˆ°ARå®¹å™¨
        if (arScene) {
          arScene.appendChild(canvas);
        }
        
        // åˆå§‹åŒ–WebXRæ¸²æŸ“ä¸Šä¸‹æ–‡
        const gl = canvas.getContext('webgl2', { xrCompatible: true });
        if (!gl) {
          throw new Error('WebGL2 ä¸æ”¯æ´');
        }
        
        // ç¶å®šWebXRæœƒè©±
        await gl.makeXRCompatible();
        
        // å‰µå»ºç¾å¯¦ä¸–ç•ŒARç³»çµ±
        const realWorldAR = {
          session: session,
          canvas: canvas,
          gl: gl,
          anchors: new Map(), // å„²å­˜ç¾å¯¦ä¸–ç•ŒéŒ¨é»
          hitTestSource: null,
          referenceSpace: null,
          planeDetection: null,
          depthSensing: null,
          qrAnchors: new Map() // å„²å­˜QRç¢¼çš„ç¾å¯¦ä¸–ç•ŒéŒ¨é»
        };
        
        // åˆå§‹åŒ–ç¾å¯¦ä¸–ç•Œè¿½è¹¤
        await initRealWorldTracking(realWorldAR);
        
        // å„²å­˜ç¾å¯¦ä¸–ç•ŒARç³»çµ±
        window.realWorldAR = realWorldAR;
        
        console.log('ç¾å¯¦ä¸–ç•ŒARç³»çµ±åˆå§‹åŒ–å®Œæˆ');
        setStatus('è˜‹æœåŸç”Ÿç¾å¯¦ä¸–ç•ŒARç³»çµ±å·²å•Ÿå‹•', 'success');
      }

      // åˆå§‹åŒ–ç¾å¯¦ä¸–ç•Œè¿½è¹¤
      async function initRealWorldTracking(realWorldAR) {
        const { session, gl } = realWorldAR;
        
        // å‰µå»ºæœ¬åœ°åƒè€ƒç©ºé–“
        realWorldAR.referenceSpace = await session.requestReferenceSpace('local');
        
        // å‰µå»ºå‘½ä¸­æ¸¬è©¦ä¾†æº
        const space = await session.requestReferenceSpace('viewer');
        realWorldAR.hitTestSource = await session.requestHitTestSource({ space });
        
        // åˆå§‹åŒ–å¹³é¢æª¢æ¸¬
        if (session.requestHitTestSourceForTransientInput) {
          realWorldAR.planeDetection = await session.requestHitTestSourceForTransientInput({
            profile: 'generic-touchscreen',
            offsetRay: { origin: { x: 0, y: 0, z: 0, w: 1 }, direction: { x: 0, y: 0, z: -1, w: 0 } }
          });
        }
        
        // åˆå§‹åŒ–æ·±åº¦æ„Ÿæ¸¬
        if (session.requestDepthSensing) {
          try {
            realWorldAR.depthSensing = await session.requestDepthSensing({
              usagePreference: ['cpu-optimized', 'gpu-optimized'],
              dataFormatPreference: ['luminance-alpha', 'float32']
            });
            console.log('æ·±åº¦æ„Ÿæ¸¬å·²å•Ÿç”¨');
          } catch (error) {
            console.log('æ·±åº¦æ„Ÿæ¸¬ä¸å¯ç”¨:', error);
          }
        }
        
        // è¨­ç½®ARæœƒè©±äº‹ä»¶ç›£è½
        session.addEventListener('end', () => {
          console.log('ARæœƒè©±çµæŸ');
          setStatus('ARæœƒè©±å·²çµæŸ', 'info');
        });
        
        console.log('ç¾å¯¦ä¸–ç•Œè¿½è¹¤ç³»çµ±å·²åˆå§‹åŒ–');
      }

      // è¨˜éŒ„ç¾å¯¦ä¸–ç•Œ3Dåº§æ¨™ä¸¦å‰µå»ºARéŒ¨é»
      async function record3DCoordinates(position, size) {
        try {
          // æª¢æŸ¥æ˜¯å¦æœ‰ç¾å¯¦ä¸–ç•ŒARç³»çµ±
          if (!window.realWorldAR) {
            console.log('ç¾å¯¦ä¸–ç•ŒARç³»çµ±æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨2Dåº§æ¨™');
            return {
              x: position.x,
              y: position.y,
              z: 0,
              type: '2D',
              timestamp: Date.now()
            };
          }

          const { session, hitTestSource, referenceSpace, depthSensing } = window.realWorldAR;
          
          // è¨ˆç®—QRç¢¼ä¸­å¿ƒé»
          const centerX = position.x + size.width / 2;
          const centerY = position.y + size.height / 2;
          
          // å°‡2Dåº§æ¨™è½‰æ›ç‚º3Då°„ç·šï¼ˆå¾ç›¸æ©Ÿå‘QRç¢¼ç™¼å°„ï¼‰
          const ray = {
            origin: { x: centerX, y: centerY, z: 0, w: 1 },
            direction: { x: 0, y: 0, z: -1, w: 0 }
          };
          
          // ä½¿ç”¨æ­£ç¢ºçš„WebXR APIåŸ·è¡Œå‘½ä¸­æ¸¬è©¦
          if (hitTestSource) {
            // å°‡2Dåº§æ¨™è½‰æ›ç‚ºæ­¸ä¸€åŒ–è¨­å‚™åº§æ¨™ (NDC)
            const video = document.getElementById('video');
            const videoWidth = video.videoWidth || video.clientWidth;
            const videoHeight = video.videoHeight || video.clientHeight;
            
            const normalizedX = (centerX / videoWidth) * 2 - 1;
            const normalizedY = -((centerY / videoHeight) * 2 - 1);
            
            // å‰µå»ºå°„ç·š
            const ray = new XRRay(
              new DOMPoint(0, 0, 0), // å¾ç›¸æ©Ÿä¸­å¿ƒç™¼å°„
              new DOMPoint(normalizedX, normalizedY, -1) // æŒ‡å‘QRç¢¼æ–¹å‘
            );
            
            // åŸ·è¡Œå‘½ä¸­æ¸¬è©¦
            const hitTestResults = await hitTestSource.requestHitTest(ray, referenceSpace);
            
            if (hitTestResults && hitTestResults.length > 0) {
              const hit = hitTestResults[0];
              const pose = hit.getPose(referenceSpace);
              
              if (pose) {
                const transform = pose.transform;
                const position3D = transform.position;
                const orientation3D = transform.orientation;
                
                // å‰µå»ºARéŒ¨é»ï¼Œå°‡æ¨™è¨˜å›ºå®šåœ¨ç¾å¯¦ä¸–ç•Œä¸­
                const anchor = await createARAnchor(position3D, orientation3D, referenceSpace);
                
                const coordinates3D = {
                  x: position3D.x,
                  y: position3D.y,
                  z: position3D.z,
                  orientation: {
                    x: orientation3D.x,
                    y: orientation3D.y,
                    z: orientation3D.z,
                    w: orientation3D.w
                  },
                  type: '3D_REAL_WORLD',
                  timestamp: Date.now(),
                  confidence: hit.confidence || 1.0,
                  anchor: anchor,
                  distance: calculateDistance(position3D)
                };
                
                console.log('ç¾å¯¦ä¸–ç•Œ3Dåº§æ¨™è¨˜éŒ„æˆåŠŸ:', coordinates3D);
                return coordinates3D;
              }
            }
          }
          
          // å¦‚æœå‘½ä¸­æ¸¬è©¦å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨æ·±åº¦æ„Ÿæ¸¬
          if (depthSensing) {
            const depthData = await getDepthAtPosition(centerX, centerY, depthSensing);
            if (depthData) {
              const coordinates3D = {
                x: centerX,
                y: centerY,
                z: depthData.depth,
                type: '3D_DEPTH',
                timestamp: Date.now(),
                confidence: depthData.confidence,
                distance: depthData.depth
              };
              
              console.log('æ·±åº¦æ„Ÿæ¸¬3Dåº§æ¨™è¨˜éŒ„æˆåŠŸ:', coordinates3D);
              return coordinates3D;
            }
          }
          
          // å¦‚æœéƒ½å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨è¨­å‚™æ„Ÿæ¸¬å™¨ä¼°ç®—3Dä½ç½®
          const sensor3D = await estimate3DWithSensors(position, size);
          if (sensor3D) {
            console.log('ä½¿ç”¨è¨­å‚™æ„Ÿæ¸¬å™¨ä¼°ç®—3Dä½ç½®æˆåŠŸ:', sensor3D);
            return sensor3D;
          }
          
          // æœ€å¾Œè¿”å›2Dåº§æ¨™
          console.log('ç¾å¯¦ä¸–ç•Œå®šä½å¤±æ•—ï¼Œä½¿ç”¨2Dåº§æ¨™');
          return {
            x: position.x,
            y: position.y,
            z: 0,
            type: '2D',
            timestamp: Date.now()
          };
          
        } catch (error) {
          console.error('ç¾å¯¦ä¸–ç•Œ3Dåº§æ¨™è¨˜éŒ„å¤±æ•—:', error);
          return {
            x: position.x,
            y: position.y,
            z: 0,
            type: '2D',
            timestamp: Date.now(),
            error: error.message
          };
        }
      }

      // å‰µå»ºARéŒ¨é»
      async function createARAnchor(position, orientation, referenceSpace) {
        try {
          if (window.realWorldAR && window.realWorldAR.session.createAnchor) {
            // å‰µå»ºXRRigidTransform
            const transform = new XRRigidTransform(position, orientation);
            
            // å‰µå»ºARéŒ¨é»
            const anchor = await window.realWorldAR.session.createAnchor(transform, referenceSpace);
            
            console.log('ARéŒ¨é»å‰µå»ºæˆåŠŸ:', anchor);
            return anchor;
          }
        } catch (error) {
          console.error('ARéŒ¨é»å‰µå»ºå¤±æ•—:', error);
        }
        return null;
      }

      // è¨ˆç®—è·é›¢
      function calculateDistance(position) {
        return Math.sqrt(position.x * position.x + position.y * position.y + position.z * position.z);
      }

      // ç²å–æŒ‡å®šä½ç½®çš„æ·±åº¦è³‡è¨Š
      async function getDepthAtPosition(x, y, depthSensing) {
        try {
          if (depthSensing && depthSensing.getDepthInMeters) {
            const depth = await depthSensing.getDepthInMeters(x, y);
            return {
              depth: depth,
              confidence: 0.8
            };
          }
        } catch (error) {
          console.error('æ·±åº¦æ„Ÿæ¸¬å¤±æ•—:', error);
        }
        return null;
      }

      // ä½¿ç”¨è¨­å‚™æ„Ÿæ¸¬å™¨ä¼°ç®—3Dä½ç½®
      async function estimate3DWithSensors(position, size) {
        try {
          // æª¢æŸ¥æ˜¯å¦æ”¯æ´è¨­å‚™æ–¹å‘API
          if (!window.DeviceOrientationEvent) {
            console.log('è¨­å‚™æ–¹å‘APIä¸æ”¯æ´');
            return null;
          }

          // è«‹æ±‚è¨­å‚™æ–¹å‘æ¬Šé™
          if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            const permission = await DeviceOrientationEvent.requestPermission();
            if (permission !== 'granted') {
              console.log('è¨­å‚™æ–¹å‘æ¬Šé™è¢«æ‹’çµ•');
              return null;
            }
          }

          // ç²å–è¨­å‚™æ–¹å‘è³‡è¨Š
          return new Promise((resolve) => {
            const handleOrientation = (event) => {
              // è¨ˆç®—QRç¢¼åœ¨è¢å¹•ä¸­çš„ä½ç½®
              const centerX = position.x + size.width / 2;
              const centerY = position.y + size.height / 2;
              
              // ç²å–è¢å¹•å°ºå¯¸
              const screenWidth = window.innerWidth;
              const screenHeight = window.innerHeight;
              
              // å°‡2Dåº§æ¨™è½‰æ›ç‚º3Dä¼°ç®—
              const normalizedX = (centerX / screenWidth) - 0.5;
              const normalizedY = (centerY / screenHeight) - 0.5;
              
              // ä½¿ç”¨è¨­å‚™æ–¹å‘ä¼°ç®—è·é›¢
              const estimatedDistance = estimateDistanceFromQRSize(size);
              
              // è¨ˆç®—3Dä½ç½®ï¼ˆåŸºæ–¼è¨­å‚™æ–¹å‘å’ŒQRç¢¼ä½ç½®ï¼‰
              const x3D = normalizedX * estimatedDistance * 0.5;
              const y3D = -normalizedY * estimatedDistance * 0.5;
              const z3D = estimatedDistance;
              
              // ä½¿ç”¨è¨­å‚™æ–¹å‘è¨ˆç®—æ—‹è½‰
              const alpha = event.alpha || 0; // Zè»¸æ—‹è½‰
              const beta = event.beta || 0;   // Xè»¸æ—‹è½‰
              const gamma = event.gamma || 0; // Yè»¸æ—‹è½‰
              
              const coordinates3D = {
                x: x3D,
                y: y3D,
                z: z3D,
                orientation: {
                  x: Math.sin(beta * Math.PI / 180),
                  y: Math.sin(gamma * Math.PI / 180),
                  z: Math.sin(alpha * Math.PI / 180),
                  w: Math.cos(alpha * Math.PI / 180)
                },
                type: '3D_SENSOR_ESTIMATED',
                timestamp: Date.now(),
                confidence: 0.7,
                distance: estimatedDistance,
                deviceOrientation: { alpha, beta, gamma }
              };
              
              // ç§»é™¤äº‹ä»¶ç›£è½å™¨
              window.removeEventListener('deviceorientation', handleOrientation);
              
              resolve(coordinates3D);
            };
            
            // æ·»åŠ äº‹ä»¶ç›£è½å™¨
            window.addEventListener('deviceorientation', handleOrientation, true);
            
            // 5ç§’å¾Œè¶…æ™‚
            setTimeout(() => {
              window.removeEventListener('deviceorientation', handleOrientation);
              resolve(null);
            }, 5000);
          });
          
        } catch (error) {
          console.error('è¨­å‚™æ„Ÿæ¸¬å™¨3Dä¼°ç®—å¤±æ•—:', error);
          return null;
        }
      }

      // æ ¹æ“šQRç¢¼å¤§å°ä¼°ç®—è·é›¢
      function estimateDistanceFromQRSize(size) {
        // QRç¢¼çš„æ¨™æº–å¤§å°ç´„ç‚º25mm
        const standardQRSize = 25; // mm
        const standardDistance = 300; // mm (30cm)
        
        // æ ¹æ“šQRç¢¼åœ¨è¢å¹•ä¸­çš„å¤§å°ä¼°ç®—è·é›¢
        const screenSize = Math.max(size.width, size.height);
        const estimatedDistance = (standardQRSize * standardDistance) / screenSize;
        
        // é™åˆ¶è·é›¢ç¯„åœ (10cm - 2m)
        return Math.max(100, Math.min(2000, estimatedDistance)) / 1000; // è½‰æ›ç‚ºç±³
      }

      // å‰µå»ºç¾å¯¦ä¸–ç•ŒARæ¨™è¨˜
      async function createRealWorldARMarker(qrCode, coordinates3D) {
        try {
          if (!window.realWorldAR) {
            console.log('ç¾å¯¦ä¸–ç•ŒARç³»çµ±æœªåˆå§‹åŒ–');
            return;
          }

          const { session, gl, canvas } = window.realWorldAR;
          
          // å‰µå»º3D ARæ¨™è¨˜ï¼ˆä½¿ç”¨WebGLæ¸²æŸ“ï¼‰
          const arMarker3D = {
            qrCode: qrCode,
            position: coordinates3D,
            anchor: coordinates3D.anchor,
            mesh: null,
            material: null
          };
          
          // å‰µå»º3Då¹¾ä½•é«”ï¼ˆç«‹æ–¹é«”æ¨™è¨˜ï¼‰
          const geometry = createARMarkerGeometry();
          const material = createARMarkerMaterial();
          
          // å°‡æ¨™è¨˜ç¶å®šåˆ°ARéŒ¨é»
          if (coordinates3D.anchor) {
            // è¨­ç½®æ¨™è¨˜çš„3Dè®Šæ›
            const transform = {
              position: coordinates3D,
              rotation: coordinates3D.orientation,
              scale: { x: 0.1, y: 0.1, z: 0.1 }
            };
            
            arMarker3D.mesh = { geometry, material, transform };
            
            // å„²å­˜åˆ°ç¾å¯¦ä¸–ç•ŒARç³»çµ±
            window.realWorldAR.qrAnchors.set(qrCode, arMarker3D);
            
            console.log('ç¾å¯¦ä¸–ç•ŒARæ¨™è¨˜å‰µå»ºæˆåŠŸ:', qrCode, coordinates3D);
            setStatus(`ç¾å¯¦ä¸–ç•ŒARæ¨™è¨˜å·²å›ºå®šåœ¨QRç¢¼ ${qrCode} ä½ç½®`, 'success');
          }
          
        } catch (error) {
          console.error('å‰µå»ºç¾å¯¦ä¸–ç•ŒARæ¨™è¨˜å¤±æ•—:', error);
        }
      }

      // å‰µå»ºARæ¨™è¨˜å¹¾ä½•é«”
      function createARMarkerGeometry() {
        // å‰µå»ºä¸€å€‹å°çš„ç«‹æ–¹é«”ä½œç‚ºARæ¨™è¨˜
        const vertices = new Float32Array([
          // å‰é¢
          -0.5, -0.5,  0.5,
           0.5, -0.5,  0.5,
           0.5,  0.5,  0.5,
          -0.5,  0.5,  0.5,
          // å¾Œé¢
          -0.5, -0.5, -0.5,
           0.5, -0.5, -0.5,
           0.5,  0.5, -0.5,
          -0.5,  0.5, -0.5
        ]);
        
        const indices = new Uint16Array([
          0, 1, 2,  0, 2, 3,  // å‰é¢
          4, 7, 6,  4, 6, 5,  // å¾Œé¢
          0, 4, 5,  0, 5, 1,  // ä¸‹é¢
          2, 6, 7,  2, 7, 3,  // ä¸Šé¢
          0, 3, 7,  0, 7, 4,  // å·¦é¢
          1, 5, 6,  1, 6, 2   // å³é¢
        ]);
        
        return { vertices, indices };
      }

      // å‰µå»ºARæ¨™è¨˜æè³ª
      function createARMarkerMaterial() {
        return {
          color: { r: 1.0, g: 0.8, b: 0.0 }, // é‡‘è‰²
          opacity: 0.8,
          metallic: 0.2,
          roughness: 0.3
        };
      }

      // èª¿æ•´ARç•«å¸ƒå¤§å°
      function resizeARCanvas() {
        if (canvas && video) {
          const rect = video.getBoundingClientRect();
          const videoWidth = video.videoWidth || rect.width;
          const videoHeight = video.videoHeight || rect.height;
          
          // è¨­å®šç•«å¸ƒå¯¦éš›å°ºå¯¸
          canvas.width = rect.width;
          canvas.height = rect.height;
          
          // è¨­å®šç•«å¸ƒé¡¯ç¤ºå°ºå¯¸
          canvas.style.width = rect.width + 'px';
          canvas.style.height = rect.height + 'px';
          
          console.log('ARç•«å¸ƒå·²èª¿æ•´:', {
            canvasSize: { width: canvas.width, height: canvas.height },
            videoSize: { width: videoWidth, height: videoHeight },
            displaySize: { width: rect.width, height: rect.height }
          });
        }
      }

      // æ·»åŠ è˜‹æœåŸç”ŸARæ¨™è¨˜
      async function addARMarker(qrCode, position, size) {
        if (!arMarkerElements.has(qrCode)) {
          // å¢åŠ æƒæè¨ˆæ•¸å™¨
          scanCounter++;
          
          // è¨˜éŒ„ç¾å¯¦ä¸–ç•Œ3Dåº§æ¨™
          const coordinates3D = await record3DCoordinates(position, size);
          
          // è¨˜éŒ„æƒæé †åº
          const scanInfo = {
            qrCode: qrCode,
            order: scanCounter,
            timestamp: Date.now(),
            timeString: new Date().toLocaleTimeString(),
            coordinates3D: coordinates3D
          };
          scanOrder.push(scanInfo);
          
          // å¦‚æœæ˜¯ç¾å¯¦ä¸–ç•Œ3Dåº§æ¨™ï¼Œå‰µå»ºARéŒ¨é»
          if (coordinates3D.type === '3D_REAL_WORLD' && coordinates3D.anchor) {
            await createRealWorldARMarker(qrCode, coordinates3D);
          }
          
          // å‰µå»º3D ARæ¨™è¨˜å…ƒç´ 
          const arMarker = document.createElement('div');
          arMarker.id = `ar-marker-${qrCode}`;
          arMarker.className = 'ar-marker-3d';
          
          // è¨ˆç®—ARæ¨™è¨˜çš„ç›¸å°ä½ç½®ï¼ˆä½¿ç”¨ç™¾åˆ†æ¯”ï¼Œä¸ä¾è³´getBoundingClientRectï¼‰
          const video = document.getElementById('video');
          const videoWidth = video.videoWidth || video.clientWidth;
          const videoHeight = video.videoHeight || video.clientHeight;
          
          // QRç¢¼åœ¨videoä¸­çš„ç›¸å°ä½ç½®ï¼ˆç™¾åˆ†æ¯”ï¼‰
          const qrCenterX = position.x + size.width / 2;
          const qrCenterY = position.y + size.height / 2;
          
          // è½‰æ›ç‚ºç™¾åˆ†æ¯”ä½ç½®
          const percentX = (qrCenterX / videoWidth) * 100;
          const percentY = (qrCenterY / videoHeight) * 100;
          
          // è¨­å®šARæ¨™è¨˜ä½ç½®å’Œæ¨£å¼ï¼ˆä½¿ç”¨ç™¾åˆ†æ¯”å®šä½ï¼‰
          arMarker.style.cssText = `
            position: absolute;
            left: ${percentX}%;
            top: ${percentY}%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1000;
            animation: arMarkerAppear 0.5s ease-out;
          `;
          
          console.log('ARæ¨™è¨˜ä½ç½®è¨ˆç®—:', {
            qrPosition: { x: position.x, y: position.y },
            qrSize: size,
            qrCenter: { x: qrCenterX, y: qrCenterY },
            videoDimensions: { width: videoWidth, height: videoHeight },
            percentPosition: { x: percentX, y: percentY }
          });
          
          // å‰µå»ºARæ¨™è¨˜å…§å®¹
          arMarker.innerHTML = `
            <div class="ar-marker-content">
              <!-- é †åºè™Ÿç¢¼åœ“åœˆ -->
              <div class="ar-order-circle">
                <span class="ar-order-number">${scanCounter}</span>
              </div>
              
              <!-- QRç¢¼ç·¨è™Ÿ -->
              <div class="ar-qr-label">
                <span class="ar-qr-text">${qrCode}</span>
              </div>
              
              <!-- å°å‹¾æ¨™è¨˜ -->
              <div class="ar-checkmark">âœ“</div>
            </div>
          `;
          
          // æ·»åŠ åˆ°ARå ´æ™¯
          if (arScene) {
            arScene.appendChild(arMarker);
            arMarkerElements.set(qrCode, arMarker);
          }
          
          // åŒæ™‚ä¿å­˜åˆ°å‚³çµ±æ¨™è¨˜ç³»çµ±
          qrMarkers.set(qrCode, {
            position: position,
            size: size,
            timestamp: Date.now(),
            scanned: true,
            scanOrder: scanCounter,
            scanTime: scanInfo.timeString,
            arMarker: arMarker
          });
          
          console.log('æ·»åŠ è˜‹æœåŸç”ŸARæ¨™è¨˜:', {
            qrCode,
            scanOrder: scanCounter,
            scanTime: scanInfo.timeString,
            position: { x: centerX, y: centerY },
            originalPosition: position,
            originalSize: size
          });
          
          updateScanOrderDisplay();
        }
      }

      // ç¹ªè£½ARæ¨™è¨˜
      function drawARMarkers() {
        if (!ctx || !canvas) return;
        
        // æ¸…é™¤ç•«å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        console.log('ç¹ªè£½ARæ¨™è¨˜ï¼Œç¸½æ•¸:', qrMarkers.size);
        
        // ç¹ªè£½æ‰€æœ‰æ¨™è¨˜
        qrMarkers.forEach((marker, qrCode) => {
          const { position, size } = marker;
          
          const centerX = position.x + size.width / 2;
          const centerY = position.y + size.height / 2;
          const radius = Math.max(size.width, size.height) / 2 + 15;
          
          // ç¹ªè£½å¤–åœˆï¼ˆæ›´æ˜é¡¯ï¼‰
          ctx.strokeStyle = '#FF0000';
          ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';
          ctx.lineWidth = 4;
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
          ctx.fill();
          ctx.stroke();
          
          // ç¹ªè£½å…§åœˆï¼ˆç¶ è‰²ï¼‰
          ctx.strokeStyle = '#00FF00';
          ctx.fillStyle = 'rgba(0, 255, 0, 0.3)';
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius - 5, 0, 2 * Math.PI);
          ctx.fill();
          ctx.stroke();
          
          // ç¹ªè£½å°å‹¾æ¨™è¨˜ï¼ˆæ›´ç²—æ›´æ˜é¡¯ï¼‰
          ctx.strokeStyle = '#FFFFFF';
          ctx.lineWidth = 6;
          ctx.beginPath();
          ctx.moveTo(centerX - radius/2, centerY);
          ctx.lineTo(centerX - radius/4, centerY + radius/4);
          ctx.lineTo(centerX + radius/2, centerY - radius/4);
          ctx.stroke();
          
          // ç¹ªè£½æƒæé †åºè™Ÿç¢¼ï¼ˆåœ“åœˆèƒŒæ™¯ï¼‰
          const orderText = marker.scanOrder.toString();
          ctx.fillStyle = '#FFD700'; // é‡‘è‰²èƒŒæ™¯
          ctx.strokeStyle = '#000000';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(centerX - radius + 15, centerY - radius + 15, 20, 0, 2 * Math.PI);
          ctx.fill();
          ctx.stroke();
          
          // ç¹ªè£½é †åºè™Ÿç¢¼
          ctx.fillStyle = '#000000';
          ctx.font = 'bold 14px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(orderText, centerX - radius + 15, centerY - radius + 20);
          
          // ç¹ªè£½QRç¢¼ç·¨è™Ÿï¼ˆæ›´å¤§æ›´æ˜é¡¯ï¼‰
          ctx.fillStyle = '#FFFFFF';
          ctx.strokeStyle = '#000000';
          ctx.lineWidth = 2;
          ctx.font = 'bold 14px Arial';
          ctx.textAlign = 'center';
          ctx.strokeText(qrCode, centerX, centerY + radius + 25);
          ctx.fillText(qrCode, centerX, centerY + radius + 25);
          
          console.log('ç¹ªè£½æ¨™è¨˜:', {
            qrCode,
            centerX,
            centerY,
            radius,
            position,
            size
          });
        });
      }

      // æ›´æ–°æƒæé †åºé¡¯ç¤º
      function updateScanOrderDisplay() {
        const orderList = document.getElementById('scanOrderList');
        const orderSection = document.getElementById('scanOrderSection');
        
        if (!orderList || !orderSection) return;
        
        // æŒ‰æƒæé †åºæ’åº
        const sortedOrder = scanOrder.sort((a, b) => a.order - b.order);
        
        if (sortedOrder.length > 0) {
          orderSection.style.display = 'block';
          
          orderList.innerHTML = '';
          sortedOrder.forEach((item, index) => {
            const orderItem = document.createElement('div');
            orderItem.className = 'order-item';
            orderItem.innerHTML = `
              <span class="order-number">${item.order}</span>
              <span class="order-qr">${item.qrCode}</span>
              <span class="order-time">${item.timeString}</span>
            `;
            orderList.appendChild(orderItem);
          });
        } else {
          orderSection.style.display = 'none';
        }
      }

      // æ¸…é™¤ARæ¨™è¨˜
      function clearARMarkers() {
        // æ¸…é™¤3D ARæ¨™è¨˜
        arMarkerElements.forEach((marker, qrCode) => {
          if (marker && marker.parentNode) {
            marker.parentNode.removeChild(marker);
          }
        });
        arMarkerElements.clear();
        
        // æ¸…é™¤å‚³çµ±æ¨™è¨˜
        qrMarkers.clear();
        scanOrder = [];
        scanCounter = 0;
        
        if (ctx && canvas) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        updateScanOrderDisplay();
      }

      // æ™ºèƒ½æƒææç¤º
      function showScanningTips() {
        const tipsElement = document.getElementById('scanningTips');
        if (tipsElement) {
          tipsElement.style.display = 'block';
          
          // 3ç§’å¾Œè‡ªå‹•éš±è—æç¤º
          if (scanningTipsTimeout) {
            clearTimeout(scanningTipsTimeout);
          }
          scanningTipsTimeout = setTimeout(() => {
            tipsElement.style.display = 'none';
          }, 3000);
        }
      }

      // æ‰‹å‹•åˆå§‹åŒ–AR
      async function manualInitAR() {
        try {
          setStatus('æ­£åœ¨æ‰‹å‹•åˆå§‹åŒ–ARç³»çµ±...', 'info');
          
          // æ¸…é™¤ç¾æœ‰çš„ARå ´æ™¯
          if (arScene && arScene.parentNode) {
            arScene.parentNode.removeChild(arScene);
            arScene = null;
          }
          
          // é‡æ–°åˆå§‹åŒ–ARæ¨™è¨˜ç³»çµ±
          await initARMarkers();
          
          setStatus('ARç³»çµ±æ‰‹å‹•åˆå§‹åŒ–å®Œæˆï¼', 'success');
          
          // æª¢æŸ¥åˆå§‹åŒ–çµæœ
          setTimeout(() => {
            checkARStatus();
          }, 1000);
          
        } catch (error) {
          console.error('æ‰‹å‹•åˆå§‹åŒ–ARå¤±æ•—:', error);
          setStatus('ARç³»çµ±æ‰‹å‹•åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
        }
      }

      // å•Ÿå‹•WebXR ARæœƒè©±
      async function startWebXRSession() {
        try {
          if (!('xr' in navigator)) {
            setStatus('WebXR API ä¸æ”¯æ´', 'error');
            return;
          }

          const isSupported = await navigator.xr.isSessionSupported('immersive-ar');
          if (!isSupported) {
            setStatus('WebXR AR ä¸æ”¯æ´', 'error');
            return;
          }

          setStatus('æ­£åœ¨å•Ÿå‹•WebXR ARæœƒè©±...', 'info');

          // è«‹æ±‚WebXR ARæœƒè©±ï¼Œå•Ÿç”¨æ‰€æœ‰ARåŠŸèƒ½
          const session = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures: ['local', 'hit-test', 'anchors', 'plane-detection'],
            optionalFeatures: ['dom-overlay', 'light-estimation', 'depth-sensing', 'camera-access']
          });

          // åˆå§‹åŒ–ç¾å¯¦ä¸–ç•ŒARç³»çµ±
          await initRealWorldAR(session);

          setStatus('WebXR ARæœƒè©±å·²å•Ÿå‹•ï¼Œ3Dåº§æ¨™è¨˜éŒ„å·²å•Ÿç”¨', 'success');

        } catch (error) {
          console.error('å•Ÿå‹•WebXR ARæœƒè©±å¤±æ•—:', error);
          setStatus(`WebXR ARå•Ÿå‹•å¤±æ•—: ${error.message}`, 'error');
        }
      }

      // æ¸¬è©¦3Dåº§æ¨™è¨˜éŒ„
      async function test3DCoordinates() {
        try {
          setStatus('æ­£åœ¨æ¸¬è©¦3Dåº§æ¨™è¨˜éŒ„...', 'info');
          
          // å‰µå»ºæ¸¬è©¦ä½ç½®
          const testPosition = {
            x: 320, // è¢å¹•ä¸­å¤®
            y: 240,
            width: 100,
            height: 100
          };
          
          // æ¸¬è©¦3Dåº§æ¨™è¨˜éŒ„
          const coordinates3D = await record3DCoordinates(testPosition, { width: 100, height: 100 });
          
          // é¡¯ç¤ºçµæœ
          console.log('3Dåº§æ¨™æ¸¬è©¦çµæœ:', coordinates3D);
          
          if (coordinates3D.type.includes('3D')) {
            setStatus(`3Dåº§æ¨™è¨˜éŒ„æˆåŠŸï¼é¡å‹: ${coordinates3D.type}, è·é›¢: ${coordinates3D.distance?.toFixed(2)}m`, 'success');
            
            // é¡¯ç¤ºè©³ç´°è³‡è¨Š
            const details = `
3Dåº§æ¨™æ¸¬è©¦æˆåŠŸï¼š
- é¡å‹: ${coordinates3D.type}
- ä½ç½®: (${coordinates3D.x?.toFixed(3)}, ${coordinates3D.y?.toFixed(3)}, ${coordinates3D.z?.toFixed(3)})
- è·é›¢: ${coordinates3D.distance?.toFixed(3)}m
- ç½®ä¿¡åº¦: ${coordinates3D.confidence?.toFixed(2)}
- æ™‚é–“æˆ³: ${new Date(coordinates3D.timestamp).toLocaleTimeString()}
            `;
            console.log(details);
            
            // å¦‚æœæœ‰è¨­å‚™æ–¹å‘è³‡è¨Š
            if (coordinates3D.deviceOrientation) {
              console.log('è¨­å‚™æ–¹å‘:', coordinates3D.deviceOrientation);
            }
            
          } else {
            setStatus(`3Dåº§æ¨™è¨˜éŒ„å¤±æ•—ï¼Œä½¿ç”¨${coordinates3D.type}åº§æ¨™`, 'warning');
          }
          
        } catch (error) {
          console.error('3Dåº§æ¨™æ¸¬è©¦å¤±æ•—:', error);
          setStatus(`3Dåº§æ¨™æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
        }
      }

      // æª¢æŸ¥ARç‹€æ…‹
      function checkARStatus() {
        const status = {
          arScene: !!arScene,
          canvas: !!canvas,
          ctx: !!ctx,
          video: !!video,
          qrScanner: !!qrScanner,
          arMarkers: arMarkerElements.size,
          scanOrder: scanOrder.length,
          multiScanMode: multiScanMode
        };
        
        console.log('ARç‹€æ…‹æª¢æŸ¥:', status);
        
        let statusText = 'ARç³»çµ±ç‹€æ…‹æª¢æŸ¥ï¼š\n';
        statusText += `âœ… ARå ´æ™¯: ${status.arScene ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}\n`;
        statusText += `âœ… Canvas: ${status.canvas ? 'å·²å‰µå»º' : 'æœªå‰µå»º'}\n`;
        statusText += `âœ… ç›¸æ©Ÿ: ${status.video ? 'å·²å•Ÿå‹•' : 'æœªå•Ÿå‹•'}\n`;
        statusText += `âœ… æƒæå™¨: ${status.qrScanner ? 'å·²å•Ÿå‹•' : 'æœªå•Ÿå‹•'}\n`;
        statusText += `âœ… ARæ¨™è¨˜: ${status.arMarkers} å€‹\n`;
        statusText += `âœ… æƒæé †åº: ${status.scanOrder} å€‹\n`;
        statusText += `âœ… å¤šQRæ¨¡å¼: ${status.multiScanMode ? 'å•Ÿç”¨' : 'åœç”¨'}`;
        
        setStatus(statusText, 'info');
        
        // æª¢æŸ¥WebXRæ”¯æ´
        if (navigator.xr) {
          navigator.xr.isSessionSupported('immersive-ar').then(supported => {
            setStatus(`WebXR ARæ”¯æ´: ${supported ? 'âœ… æ”¯æ´' : 'âŒ ä¸æ”¯æ´'}`, supported ? 'success' : 'warning');
          });
        } else {
          setStatus('WebXR API: âŒ ä¸æ”¯æ´', 'warning');
        }
      }

      // ç°¡å–®æ¸¬è©¦ARæ¨™è¨˜
      function simpleTestAR() {
        const video = document.getElementById('video');
        const previewContainer = document.getElementById('preview-container');
        
        if (!video || !previewContainer) {
          setStatus('ç›¸æ©Ÿæœªå•Ÿå‹•ï¼Œè«‹å…ˆå•Ÿå‹•æƒæå™¨', 'error');
          return;
        }
        
        // å‰µå»ºä¸€å€‹ç°¡å–®çš„æ¸¬è©¦æ¨™è¨˜ï¼Œç›´æ¥æ”¾åœ¨ç›¸æ©Ÿç•«é¢ä¸­å¤®
        const testMarker = document.createElement('div');
        testMarker.id = 'simple-test-marker';
        testMarker.style.cssText = `
          position: absolute;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          width: 60px;
          height: 60px;
          background: linear-gradient(135deg, #FFD700, #FFA500);
          border: 3px solid #000;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 24px;
          font-weight: bold;
          color: #000;
          z-index: 1000;
          pointer-events: none;
          box-shadow: 0 4px 12px rgba(0,0,0,0.5);
          animation: arPulse 1s infinite;
        `;
        testMarker.textContent = '1';
        
        // æ·»åŠ åˆ°é è¦½å®¹å™¨ï¼ˆé è¦½å®¹å™¨æ‡‰è©²æ˜¯position: relativeï¼‰
        previewContainer.appendChild(testMarker);
        
        // ç¢ºä¿é è¦½å®¹å™¨æœ‰æ­£ç¢ºçš„å®šä½
        previewContainer.style.position = 'relative';
        
        setStatus('ç°¡å–®æ¸¬è©¦æ¨™è¨˜å·²æ·»åŠ åˆ°ç›¸æ©Ÿç•«é¢ä¸­å¤®', 'success');
        
        // 3ç§’å¾Œç§»é™¤
        setTimeout(() => {
          if (testMarker.parentNode) {
            testMarker.parentNode.removeChild(testMarker);
          }
          setStatus('ç°¡å–®æ¸¬è©¦æ¨™è¨˜å·²ç§»é™¤', 'info');
        }, 3000);
      }

      // æ¸¬è©¦ARæ¨™è¨˜åŠŸèƒ½
      function testARMarkers() {
        if (!arScene) {
          setStatus('ARå ´æ™¯æœªåˆå§‹åŒ–ï¼Œè«‹å…ˆå•Ÿå‹•æƒæå™¨', 'error');
          return;
        }
        
        // ä½¿ç”¨ç™¾åˆ†æ¯”ä½ç½®ï¼Œä¸ä¾è³´getBoundingClientRect
        const video = document.getElementById('video');
        const previewContainer = document.getElementById('preview-container');
        
        // åœ¨ç›¸æ©Ÿç•«é¢çš„ä¸åŒä½ç½®æ·»åŠ æ¸¬è©¦æ¨™è¨˜ï¼ˆä½¿ç”¨ç™¾åˆ†æ¯”ï¼‰
        const testPositions = [
          { 
            percentX: 25, 
            percentY: 25, 
            qr: 'TEST001' 
          },
          { 
            percentX: 75, 
            percentY: 25, 
            qr: 'TEST002' 
          },
          { 
            percentX: 50, 
            percentY: 75, 
            qr: 'TEST003' 
          }
        ];
        
        setStatus('é–‹å§‹æ¸¬è©¦ARæ¨™è¨˜ï¼Œè«‹è§€å¯Ÿç›¸æ©Ÿç•«é¢', 'info');
        
        testPositions.forEach((pos, index) => {
          setTimeout(() => {
            // ç›´æ¥å‰µå»ºæ¸¬è©¦ARæ¨™è¨˜
            const testMarker = document.createElement('div');
            testMarker.id = `test-marker-${pos.qr}`;
            testMarker.className = 'ar-marker-3d';
            testMarker.style.cssText = `
              position: absolute;
              left: ${pos.percentX}%;
              top: ${pos.percentY}%;
              transform: translate(-50%, -50%);
              pointer-events: none;
              z-index: 1000;
              animation: arMarkerAppear 0.5s ease-out;
            `;
            
            testMarker.innerHTML = `
              <div class="ar-marker-content">
                <div class="ar-order-circle">
                  <span class="ar-order-number">${index + 1}</span>
                </div>
                <div class="ar-qr-label">
                  <span class="ar-qr-text">${pos.qr}</span>
                </div>
                <div class="ar-checkmark">âœ“</div>
              </div>
            `;
            
            arScene.appendChild(testMarker);
            setStatus(`å·²æ·»åŠ æ¸¬è©¦ARæ¨™è¨˜ ${pos.qr}ï¼Œä½ç½®: (${pos.percentX}%, ${pos.percentY}%)`, 'success');
          }, index * 1000);
        });
        
        // 8ç§’å¾Œæ¸…é™¤æ‰€æœ‰æ¸¬è©¦æ¨™è¨˜
        setTimeout(() => {
          testPositions.forEach(pos => {
            const marker = document.getElementById(`test-marker-${pos.qr}`);
            if (marker && marker.parentNode) {
              marker.parentNode.removeChild(marker);
            }
          });
          setStatus('æ¸¬è©¦ARæ¨™è¨˜å·²æ¸…é™¤', 'info');
        }, 8000);
      }

      // åˆ‡æ›å¤šQRç¢¼æƒææ¨¡å¼
      function toggleMultiScanMode() {
        multiScanMode = !multiScanMode;
        const btn = document.getElementById('multiScanBtn');
        
        if (multiScanMode) {
          btn.style.background = 'linear-gradient(45deg, #4CAF50, #45a049)';
          btn.textContent = 'ğŸ“± å¤šQRç¢¼æƒææ¨¡å¼';
          setStatus('ğŸ“± å¤šQRç¢¼æƒææ¨¡å¼å·²å•Ÿç”¨ï¼Œå¯åŒæ™‚è­˜åˆ¥å¤šå€‹QRç¢¼', 'success');
        } else {
          btn.style.background = 'linear-gradient(45deg, #9E9E9E, #757575)';
          btn.textContent = 'ğŸ“± å–®ä¸€QRç¢¼æƒææ¨¡å¼';
          setStatus('ğŸ“± å–®ä¸€QRç¢¼æƒææ¨¡å¼å·²å•Ÿç”¨ï¼Œä¸€æ¬¡æƒæä¸€å€‹QRç¢¼', 'info');
        }
      }

      // æ™ºèƒ½è‡ªå‹•å°ç„¦å„ªåŒ–ï¼ˆæ”¯æ´è¿‘è·é›¢åˆ°è¶…é è·é›¢ï¼‰
      async function optimizeAutoFocus() {
        try {
          const stream = video.srcObject;
          if (!stream) return;

          const track = stream.getVideoTracks()[0];
          if (!track) return;

          const capabilities = track.getCapabilities();
          
          // æª¢æŸ¥æ˜¯å¦æ”¯æ´æ‰‹å‹•å°ç„¦
          if (capabilities.focusMode && capabilities.focusDistance) {
            // è¨­å®šé€£çºŒå°ç„¦æ¨¡å¼ï¼Œæ”¯æ´è¿‘è·é›¢åˆ°è¶…é è·é›¢æƒæ
            await track.applyConstraints({
              focusMode: 'continuous',
              focusDistance: { min: 0.1, max: 100.0 }, // æ¥µå¤§å°ç„¦ç¯„åœï¼Œæ”¯æ´è¶…é è·é›¢
              exposureMode: 'continuous',
              whiteBalanceMode: 'continuous',
              // é è·é›¢å„ªåŒ–åƒæ•¸
              zoom: { min: 1.0, max: 8.0 }, // æ”¯æ´é«˜å€æ•¸è®Šç„¦
              iso: { min: 100, max: 3200 }, // å¢åŠ ISOç¯„åœ
              brightness: { min: -0.5, max: 0.5 }, // äº®åº¦èª¿æ•´
              contrast: { min: 0.5, max: 1.5 } // å°æ¯”åº¦èª¿æ•´
            });
            
            console.log('è‡ªå‹•å°ç„¦å·²å„ªåŒ–ï¼Œæ”¯æ´è¿‘è·é›¢åˆ°è¶…é è·é›¢æƒæ');
          }
          
          // è§¸ç™¼å°ç„¦èª¿æ•´ï¼ˆè®“ç›¸æ©Ÿé‡æ–°å°ç„¦ï¼‰
          setTimeout(async () => {
            try {
              await track.applyConstraints({
                focusMode: 'continuous'
              });
            } catch (e) {
              console.log('å°ç„¦èª¿æ•´å®Œæˆ');
            }
          }, 1000);
          
        } catch (error) {
          console.log('è‡ªå‹•å°ç„¦å„ªåŒ–å¤±æ•—ï¼Œä½¿ç”¨é è¨­è¨­å®š:', error);
        }
      }

      // å°ç„¦æ§åˆ¶åŠŸèƒ½ï¼ˆä¿ç•™ä½†ä¸å†ä½¿ç”¨ï¼‰
      async function setCameraFocus(focusMode) {
        try {
          if (!qrScanner || !qrScanner._active) {
            setStatus('è«‹å…ˆå•Ÿå‹•æƒæå™¨', 'warning');
            return;
          }

          const stream = video.srcObject;
          if (!stream) {
            setStatus('ç„¡æ³•å–å¾—ç›¸æ©Ÿä¸²æµ', 'error');
            return;
          }

          const track = stream.getVideoTracks()[0];
          if (!track) {
            setStatus('ç„¡æ³•å–å¾—ç›¸æ©Ÿè»Œé“', 'error');
            return;
          }

          const capabilities = track.getCapabilities();
          if (!capabilities.focusMode || !capabilities.focusDistance) {
            setStatus('æ­¤è£ç½®ä¸æ”¯æ´æ‰‹å‹•å°ç„¦', 'warning');
            return;
          }

          let constraints;
          switch(focusMode) {
            case 'near':
              constraints = {
                focusMode: 'manual',
                focusDistance: { min: 0.1, max: 0.3 } // è¿‘è·é›¢å°ç„¦
              };
              setStatus('å·²åˆ‡æ›åˆ°è¿‘è·é›¢å°ç„¦æ¨¡å¼', 'success');
              break;
            case 'far':
              constraints = {
                focusMode: 'manual', 
                focusDistance: { min: 1.0, max: 10.0 } // é è·é›¢å°ç„¦
              };
              setStatus('å·²åˆ‡æ›åˆ°é è·é›¢å°ç„¦æ¨¡å¼', 'success');
              break;
            case 'auto':
              constraints = {
                focusMode: 'continuous'
              };
              setStatus('å·²åˆ‡æ›åˆ°è‡ªå‹•å°ç„¦æ¨¡å¼', 'success');
              break;
          }

          await track.applyConstraints(constraints);
          
          // è§¸ç™¼å°ç„¦èª¿æ•´
          if (focusMode !== 'auto') {
            setTimeout(() => {
              track.applyConstraints({ focusMode: 'continuous' }).catch(() => {});
            }, 2000);
          }
          
        } catch (error) {
          console.error('å°ç„¦è¨­å®šå¤±æ•—:', error);
          setStatus('å°ç„¦è¨­å®šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        }
      }

      // æ‰‹å‹•è¼¸å…¥ QR ç¢¼
      function manualQRInput() {
        const qrText = prompt('è«‹è¼¸å…¥ QR ç¢¼å…§å®¹ï¼š');
        if (qrText && qrText.trim()) {
          const trimmedQR = qrText.trim();
          
          // é©—è­‰QRç¢¼æ ¼å¼ï¼šå¿…é ˆæ˜¯ https://jerosse.com.tw/ é–‹é ­ä¸”å¾Œé¢æœ‰æ•¸å­—
          const jerossePattern = /^https:\/\/jerosse\.com\.tw\/(\d+)$/;
          const match = trimmedQR.match(jerossePattern);
          
          if (!match) {
            setStatus('QRç¢¼æ ¼å¼ä¸ç¬¦ï¼Œè«‹è¼¸å…¥æ­£ç¢ºçš„å©•æ¨‚çº–ç”¢å“QRç¢¼', 'warning');
            return;
          }
          
          // æå–æ•¸å­—éƒ¨åˆ†ï¼ˆä¿æŒå®Œæ•´æ ¼å¼ï¼ŒåŒ…æ‹¬å‰å°0ï¼‰
          const qrNumber = match[1];
          
          // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
          if (scannedQRs.has(qrNumber)) {
            setStatus('æ­¤ QR ç¢¼å·²å­˜åœ¨æ–¼è¨˜éŒ„ä¸­', 'warning');
            return;
          }
          
          // æ·»åŠ åˆ°æƒæè¨˜éŒ„ï¼ˆä½¿ç”¨å®Œæ•´æ•¸å­—ï¼‰
          scannedQRs.add(qrNumber);
          document.getElementById('qrText').value = qrNumber;
          updateScannedList();
          setStatus(`QR ç¢¼å·²æ‰‹å‹•è¼¸å…¥ï¼å·²è¨˜éŒ„ ${scannedQRs.size} å€‹ QR ç¢¼`, 'success');
        }
      }

      // è™•ç†è¡¨å–®æäº¤
      async function handleFormSubmit(event) {
        event.preventDefault();
        
        const gasUrl = document.getElementById('gasUrl').value.trim();
        if (!gasUrl) {
          setStatus('è«‹å…ˆè¨­å®š Apps Script æœå‹™ç¶²å€', 'error');
          return;
        }

        // å–å¾—è¡¨å–®è³‡æ–™
        const productName = document.getElementById('productName').value;
        const expiryDate = document.getElementById('expiryDate').value;
        const qrText = document.getElementById('qrText').value;
        const staffName = document.getElementById('staffName').value;
        
        // å–å¾—æ‰¹è™Ÿï¼ˆå¯èƒ½æ˜¯ input æˆ– selectï¼‰
        let batchNumber = '';
        const batchInput = document.getElementById('batchNumber');
        const batchSelect = document.querySelector('select.batch-select');
        
        if (batchSelect && batchSelect.style.display !== 'none') {
          batchNumber = batchSelect.value;
        } else {
          batchNumber = batchInput.value;
        }

        // é©—è­‰å¿…å¡«æ¬„ä½
        if (!productName || !expiryDate || !batchNumber || !qrText || !staffName) {
          setStatus('è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
          return;
        }
        
        // è™•ç†QRç¢¼ï¼šæ‰¹é‡æ¨¡å¼æ™‚åˆ†å‰²å¤šå€‹QRç¢¼
        const qrCodes = qrText.split(',').map(qr => qr.trim()).filter(qr => qr);
        if (qrCodes.length === 0) {
          setStatus('è«‹è‡³å°‘æƒæä¸€å€‹QRç¢¼', 'error');
          return;
        }

        setStatus(`é€å‡ºä¸­... (${qrCodes.length} ç­†è¨˜éŒ„)`, 'info');
        
        try {
          // æº–å‚™æ‰¹é‡è¨˜éŒ„
          const records = qrCodes.map(qrCode => ({
            productName: productName.trim(),
            expiryDate: expiryDate.trim(),
            batchNumber: batchNumber.trim(),
            qrText: qrCode, // å–®ä¸€QRç¢¼
            staffName: staffName.trim(),
            timestamp: new Date().toISOString(),
          }));
          
          // èª¿è©¦ï¼šç¢ºèªæ‰¹é‡è¨˜éŒ„
          console.log('æ‰¹é‡æäº¤è¨˜éŒ„:', records);
          console.log('è¨˜éŒ„æ•¸é‡:', records.length);

          const response = await fetch(gasUrl, {
            method: 'POST',
            // ä½¿ç”¨ç°¡å–®è«‹æ±‚ä»¥é¿é–‹ Apps Script çš„ CORS é æª¢
            headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
            body: JSON.stringify({ action: 'appendBatch', records: records }),
          });
          
          const data = await response.json();
          
          if (data && data.ok && data.results) {
            const successCount = data.results.filter(r => r.ok).length;
            const errorCount = data.results.filter(r => !r.ok).length;
            
            setStatus(`å·²æˆåŠŸå¯«å…¥ ${successCount} ç­†è¨˜éŒ„${errorCount > 0 ? `ï¼Œ${errorCount} ç­†å¤±æ•—` : ''}`, 'success');
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('recordForm').reset();
            document.getElementById('qrText').value = '';
            document.getElementById('staffName').value = '';
            
            // æ¸…ç©ºæƒæè¨˜éŒ„
            scannedQRs.clear();
            updateScannedList();
            
            // æ¸…ç©ºARæ¨™è¨˜
            clearAllMarkers();
            
            // é‡ç½®æ‰¹è™Ÿæ¬„ä½
            setBatchAsInput(batchInput, '', true);
            
            // é‡ç½®æ‰¹é‡æ¨¡å¼
            document.getElementById('batchMode').checked = false;
            batchMode = false;
            
          } else {
            setStatus(`æ‰¹é‡å¯«å…¥å¤±æ•—ï¼š${(data && data.error) || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
          }
        } catch (error) {
          setStatus('é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ–æœå‹™éƒ¨ç½²', 'error');
          console.error('è¡¨å–®æäº¤å¤±æ•—:', error);
        }
      }

      // ç¶å®šäº‹ä»¶
      document.addEventListener('DOMContentLoaded', function() {
        const productSelect = document.getElementById('productName');
        const expiryInput = document.getElementById('expiryDate');
        const startScanBtn = document.getElementById('startScan');
        const stopScanBtn = document.getElementById('stopScan');
        const gasUrlInput = document.getElementById('gasUrl');
        const pingBtn = document.getElementById('pingService');
        
        if (productSelect) {
          productSelect.addEventListener('change', queryAutoBatch);
        }
        if (expiryInput) {
          expiryInput.addEventListener('change', queryAutoBatch);
        }
        if (startScanBtn) {
          startScanBtn.addEventListener('click', startBarcodeScanner);
        }
        if (stopScanBtn) {
          stopScanBtn.addEventListener('click', stopBarcodeScanner);
        }
        
        // è¼‰å…¥/ä¿å­˜ Apps Script URL
        const DEFAULT_GAS_URL = 'https://script.google.com/macros/s/AKfycbxqIV8fevVTSjcykeaS7N2LDVIzDNCYfefwxqFCunC-5JAZGhelwMtqtAghRaDWp1Lf/exec';
        try {
          const saved = localStorage.getItem('gasUrl');
          gasUrlInput.value = (saved && saved.trim()) ? saved.trim() : DEFAULT_GAS_URL;
        } catch {}
        if (gasUrlInput) {
          gasUrlInput.addEventListener('change', function() {
            try { localStorage.setItem('gasUrl', this.value.trim()); } catch {}
          });
        }

        // æ¸¬è©¦é€£ç·š
        if (pingBtn) {
          pingBtn.addEventListener('click', function() { pingService(false); });
        }

        // æ‰‹å‹•è¼¸å…¥ QR ç¢¼æŒ‰éˆ•
        const manualQRBtn = document.getElementById('manualQR');
        if (manualQRBtn) {
          manualQRBtn.addEventListener('click', manualQRInput);
        }

        // æ¸…é™¤æ¨™è¨˜æŒ‰éˆ•
        const clearMarkersBtn = document.getElementById('clearMarkers');
        if (clearMarkersBtn) {
          clearMarkersBtn.addEventListener('click', clearAllMarkers);
        }

        // é‡æ–°å°ç„¦æŒ‰éˆ•
        const refocusBtn = document.getElementById('refocusBtn');
        if (refocusBtn) {
          refocusBtn.addEventListener('click', async () => {
            if (qrScanner && qrScanner._active) {
              setStatus('æ­£åœ¨é‡æ–°å°ç„¦ï¼Œè«‹ç¨å€™...', 'info');
              await optimizeAutoFocus();
              setStatus('å°ç„¦å®Œæˆï¼Œè«‹é‡æ–°å˜—è©¦æƒæ', 'success');
            } else {
              setStatus('è«‹å…ˆå•Ÿå‹•æƒæå™¨', 'warning');
            }
          });
        }

        // å¤šQRç¢¼æƒææ¨¡å¼æŒ‰éˆ•
        const multiScanBtn = document.getElementById('multiScanBtn');
        if (multiScanBtn) {
          multiScanBtn.addEventListener('click', toggleMultiScanMode);
        }

        // æ¸¬è©¦ARæ¨™è¨˜æŒ‰éˆ•
        const testARBtn = document.getElementById('testARBtn');
        if (testARBtn) {
          testARBtn.addEventListener('click', testARMarkers);
        }

        // ç°¡å–®æ¸¬è©¦æŒ‰éˆ•
        const simpleTestBtn = document.getElementById('simpleTestBtn');
        if (simpleTestBtn) {
          simpleTestBtn.addEventListener('click', simpleTestAR);
        }

        // æª¢æŸ¥ARç‹€æ…‹æŒ‰éˆ•
        const checkARBtn = document.getElementById('checkARBtn');
        if (checkARBtn) {
          checkARBtn.addEventListener('click', checkARStatus);
        }

        // æ‰‹å‹•åˆå§‹åŒ–ARæŒ‰éˆ•
        const initARBtn = document.getElementById('initARBtn');
        if (initARBtn) {
          initARBtn.addEventListener('click', manualInitAR);
        }

        // å•Ÿå‹•WebXR ARæŒ‰éˆ•
        const startWebXRBtn = document.getElementById('startWebXRBtn');
        if (startWebXRBtn) {
          startWebXRBtn.addEventListener('click', startWebXRSession);
        }

        // æ¸¬è©¦3Dåº§æ¨™æŒ‰éˆ•
        const test3DCoordsBtn = document.getElementById('test3DCoordsBtn');
        if (test3DCoordsBtn) {
          test3DCoordsBtn.addEventListener('click', test3DCoordinates);
        }

        // åˆå§‹åŒ–å¤šQRç¢¼æƒææ¨¡å¼
        toggleMultiScanMode();
        
        // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–ï¼Œé‡æ–°èª¿æ•´ARç•«å¸ƒ
        window.addEventListener('resize', () => {
          setTimeout(() => {
            resizeARCanvas();
            drawARMarkers();
          }, 100);
        });

        // è¡¨å–®æäº¤äº‹ä»¶
        const recordForm = document.getElementById('recordForm');
        if (recordForm) {
          recordForm.addEventListener('submit', handleFormSubmit);
        }
        // é–‹å•Ÿé é¢è‡ªå‹•é€£ç·šæ¸¬è©¦ï¼ˆéœé»˜ï¼‰ï¼Œå¤±æ•—æ‰æç¤º
        pingService(true).then(ok => { if (!ok) setStatus('ç„¡æ³•é€£ç·š Apps Scriptï¼Œè«‹ç¢ºèªç¶²å€æˆ–éƒ¨ç½²', 'warning'); });
        
        // åˆå§‹åŒ–ARåŠŸèƒ½
        initAR();
        
        // æ¢å¾©ä¹‹å‰ä¿å­˜çš„æ¨™è¨˜
        restoreMarkers();
      });
    </script>
    <!-- ç§»é™¤ ZXingBrowserï¼Œæ”¹ç”¨åŸç”Ÿç›¸æ©Ÿ API -->
  </body>
  </html>


