<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>產品掃描與紀錄</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <main class="container">
      <h1>產品掃描與紀錄</h1>

      <section class="card">
        <h2>掃描 QR 碼</h2>
        <div id="preview-container">
          <video id="video" playsinline muted></video>
          <canvas id="overlay" class="overlay"></canvas>
        </div>
        <div class="row">
          <button id="startScan">開始掃描</button>
          <button id="stopScan" disabled>停止掃描</button>
          <button id="switchCamera" disabled>切換鏡頭</button>
        </div>
        <div class="hint">若無法開啟鏡頭，請確認瀏覽器權限或改用 Safari。</div>
      </section>

      <section class="card">
        <h2>輸入資料</h2>
        <form id="recordForm">
          <label>
            重工地點
            <select id="reworkType" required onchange="updateProductOptions()">
              <option value="">請選擇重工地點</option>
              <option value="廠內重工">廠內重工</option>
              <option value="廠外重工">廠外重工</option>
            </select>
          </label>

          <label>
            產品名稱
            <select id="productName" required disabled>
              <option value="">請先選擇重工地點</option>
            </select>
          </label>

          <label>
            效期
            <input type="date" id="expiryDate" required />
          </label>

          <label>
            批號（自動帶入）
            <input type="text" id="batchNumber" required readonly />
          </label>

          <label>
            QR 內容（唯一本盒）
            <input type="text" id="qrText" required readonly />
          </label>

          <div class="row">
            <button type="submit" id="submitBtn">送出到試算表</button>
          </div>
          <div id="status" class="status"></div>
        </form>
      </section>

      <section class="card">
        <h2>Apps Script 服務設定</h2>
        <p class="small">批號會自動從「全產品批號版本」試算表查詢帶入</p>
        <div class="row">
          <label class="inline">
            Apps Script 服務網址
            <input type="url" id="gasUrl" placeholder="https://script.google.com/macros/s/xxx/exec" />
          </label>
        </div>
        <details>
          <summary>連線測試與設定</summary>
          <div class="row">
            <button id="pingService" type="button">測試連線</button>
            <span id="pingResult" class="status"></span>
          </div>
        </details>
      </section>

      <footer>
        <small>建議使用 iPhone 的 Safari 開啟此頁。資料僅於送出時寫入 Google 試算表。</small>
      </footer>
    </main>

    <script>
      // 產品分類資料
      const PRODUCT_CATEGORIES = {
        "廠內重工": ["纖纖飲", "肽纖飲-可可", "厚焙奶茶", "水光錠", "水光面膜", "雪聚露", "婕肌零", "身體油", "護手霜", "玻尿酸", "洗髮露", "養髮液", "葉黃素EX飲", "葉黃素果凍", "正冠茶"],
        "廠外重工": ["纖飄錠", "爆纖錠", "纖酵宿", "紫纖飲", "益生菌", "固樂纖"]
      };

      // 全域函數：更新產品選項
      function updateProductOptions() {
        const reworkType = document.getElementById('reworkType').value;
        const productSelect = document.getElementById('productName');
        
        console.log('updateProductOptions called with reworkType:', reworkType);
        
        // 清空現有選項
        productSelect.innerHTML = '';
        
        if (!reworkType) {
          productSelect.innerHTML = '<option value="">請先選擇重工地點</option>';
          productSelect.disabled = true;
          return;
        }
        
        // 啟用產品選擇
        productSelect.disabled = false;
        productSelect.innerHTML = '<option value="">請選擇產品</option>';
        
        // 加入該類別的產品
        const products = PRODUCT_CATEGORIES[reworkType] || [];
        console.log('Updating products for:', reworkType, products);
        
        products.forEach(product => {
          const option = document.createElement('option');
          option.value = product;
          option.textContent = product;
          productSelect.appendChild(option);
        });
        
        console.log('Product options updated, total options:', productSelect.options.length);
      }
    </script>
    <script src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js" onload="initApp()" onerror="console.error('Failed to load ZXingBrowser')"></script>
    <script>
      function initApp() {
        if (typeof ZXingBrowser !== 'undefined') {
          console.log('ZXingBrowser loaded successfully');
          // 動態載入 app.js
          const script = document.createElement('script');
          script.src = 'app.js';
          document.head.appendChild(script);
        } else {
          console.error('ZXingBrowser still not available');
        }
      }
    </script>
  </body>
  </html>


