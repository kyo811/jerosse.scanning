<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>產品掃描與紀錄</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <main class="container">
      <h1>產品掃描與紀錄</h1>

      <section class="card">
        <h2>掃描 QR 碼</h2>
        <div id="preview-container">
          <video id="video" playsinline muted></video>
          <canvas id="overlay" class="overlay"></canvas>
        </div>
        <div class="row">
          <button id="startScan">開始掃描</button>
          <button id="stopScan" disabled>停止掃描</button>
          <button id="manualQR" type="button">手動輸入 QR</button>
        </div>
        <div class="hint">若無法開啟鏡頭，請確認瀏覽器權限或改用 Safari。</div>
        
        <!-- 掃描記錄區域 -->
        <div id="scannedList" class="scanned-list">
          <p class="small">尚未掃描任何 QR 碼</p>
        </div>
        <div class="row">
          <button id="clearAllQRs" type="button" onclick="clearAllQRs()">清空所有記錄</button>
        </div>
      </section>

      <section class="card">
        <h2>輸入資料</h2>
        <form id="recordForm">
          <label>
            重工地點
            <select id="reworkType" required onchange="updateProductOptions()">
              <option value="">請選擇重工地點</option>
              <option value="廠內重工">廠內重工</option>
              <option value="廠外重工">廠外重工</option>
            </select>
          </label>

          <label>
            產品名稱
            <select id="productName" required disabled>
              <option value="">請先選擇重工地點</option>
            </select>
          </label>

          <label>
            效期
            <input type="date" id="expiryDate" required />
          </label>

          <label>
            批號（自動帶入）
            <input type="text" id="batchNumber" required readonly />
          </label>

          <label>
            QR 內容（唯一本盒）
            <input type="text" id="qrText" required readonly />
          </label>

          <div class="row">
            <button type="submit" id="submitBtn">送出到試算表</button>
          </div>
          <div id="status" class="status"></div>
        </form>
      </section>

      <section class="card">
        <h2>Apps Script 服務設定</h2>
        <p class="small">批號會自動從「全產品批號版本」試算表查詢帶入</p>
        <div class="row">
          <label class="inline">
            Apps Script 服務網址
            <input type="url" id="gasUrl" placeholder="https://script.google.com/macros/s/xxx/exec" />
          </label>
        </div>
        <details>
          <summary>連線測試與設定</summary>
          <div class="row">
            <button id="pingService" type="button">測試連線</button>
            <span id="pingResult" class="status"></span>
          </div>
        </details>
      </section>

      <footer>
        <small>建議使用 iPhone 的 Safari 開啟此頁。資料僅於送出時寫入 Google 試算表。</small>
      </footer>
    </main>

    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <script>
      // 產品分類資料
      const PRODUCT_CATEGORIES = {
        "廠內重工": ["纖纖飲", "肽纖飲-可可", "厚焙奶茶", "水光錠", "水光面膜", "雪聚露", "婕肌零", "身體油", "護手霜", "玻尿酸", "洗髮露", "養髮液", "葉黃素EX飲", "葉黃素果凍", "正冠茶"],
        "廠外重工": ["纖飄錠", "爆纖錠", "纖酵宿", "紫纖飲", "益生菌", "固樂纖"]
      };

      // QR 掃描器實例
      let qrScanner = null;
      let scannedQRs = new Set(); // 記錄已掃描的 QR 碼，避免重複

      // 全域函數：更新產品選項
      function updateProductOptions() {
        const reworkType = document.getElementById('reworkType').value;
        const productSelect = document.getElementById('productName');
        
        console.log('updateProductOptions called with reworkType:', reworkType);
        
        // 清空現有選項
        productSelect.innerHTML = '';
        
        if (!reworkType) {
          productSelect.innerHTML = '<option value="">請先選擇重工地點</option>';
          productSelect.disabled = true;
          // 清空批號
          document.getElementById('batchNumber').value = '';
          return;
        }
        
        // 啟用產品選擇
        productSelect.disabled = false;
        productSelect.innerHTML = '<option value="">請選擇產品</option>';
        
        // 加入該類別的產品
        const products = PRODUCT_CATEGORIES[reworkType] || [];
        console.log('Updating products for:', reworkType, products);
        
        products.forEach(product => {
          const option = document.createElement('option');
          option.value = product;
          option.textContent = product;
          productSelect.appendChild(option);
        });
        
        console.log('Product options updated, total options:', productSelect.options.length);
      }

      // 查詢批號（改進版）
      async function queryAutoBatch() {
        const productName = document.getElementById('productName').value;
        const expiryDate = document.getElementById('expiryDate').value;
        const batchInput = document.getElementById('batchNumber');
        const statusDiv = document.getElementById('status');
        
        if (!productName || !expiryDate) {
          batchInput.value = '';
          setStatus('請選擇產品名稱和效期', 'info');
          return;
        }

        setStatus('查詢批號中...', 'info');
        
        try {
          const gasUrl = document.getElementById('gasUrl').value.trim();
          if (!gasUrl) {
            setStatus('請先設定 Apps Script 服務網址', 'error');
            return;
          }

          const response = await fetch(gasUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              action: 'lookupBatch', 
              data: { productName, expiryDate } 
            }),
          });
          
          const data = await response.json();
          
          if (data && data.ok && data.batch) {
            batchInput.value = data.batch;
            setStatus('批號已自動帶入', 'success');
          } else {
            batchInput.value = '';
            setStatus('查無批號，請確認產品名稱與效期', 'error');
          }
        } catch (error) {
          batchInput.value = '';
          setStatus('批號查詢失敗，請稍後再試', 'error');
          console.error('批號查詢失敗:', error);
        }
      }

      // 狀態顯示函數
      function setStatus(message, type = 'info') {
        const statusDiv = document.getElementById('status');
        if (statusDiv) {
          statusDiv.textContent = message || '';
          statusDiv.className = `status ${type}`;
        }
      }

      // 啟動 QR 掃描器
      async function startBarcodeScanner() {
        try {
          const video = document.getElementById('video');
          if (!video) {
            setStatus('找不到相機元素', 'error');
            return;
          }

          // 檢查 QR Scanner 是否載入
          if (typeof QrScanner === 'undefined') {
            setStatus('QR 掃描器載入失敗，請重新整理頁面', 'error');
            return;
          }

          // 停止現有的掃描器
          if (qrScanner) {
            qrScanner.stop();
            qrScanner.destroy();
          }

          // 建立新的 QR 掃描器
          qrScanner = new QrScanner(
            video,
            result => {
              handleQRResult(result);
            },
            {
              onDecodeError: (error) => {
                // 解碼錯誤是正常的，不需要顯示
                console.debug('QR 解碼錯誤:', error);
              },
              highlightScanRegion: true,
              highlightCodeOutline: true,
            }
          );

          // 啟動掃描器
          await qrScanner.start();
          
          // 啟用/停用按鈕
          document.getElementById('startScan').disabled = true;
          document.getElementById('stopScan').disabled = false;
          
          setStatus('QR 掃描器已啟動，請將 QR 碼對準鏡頭', 'info');
          
        } catch (error) {
          console.error('啟動 QR 掃描器失敗:', error);
          setStatus('無法啟動 QR 掃描器，請確認相機權限', 'error');
        }
      }

      // 處理 QR 掃描結果
      function handleQRResult(result) {
        const qrText = result.data;
        
        // 檢查是否已掃描過
        if (scannedQRs.has(qrText)) {
          setStatus('此 QR 碼已掃描過', 'warning');
          return;
        }

        // 記錄已掃描的 QR 碼
        scannedQRs.add(qrText);
        
        // 更新 QR 內容欄位
        document.getElementById('qrText').value = qrText;
        
        // 更新掃描記錄顯示
        updateScannedList();
        
        setStatus(`QR 碼掃描成功！已記錄 ${scannedQRs.size} 個 QR 碼`, 'success');
        
        // 震動提示（如果支援）
        if (navigator.vibrate) {
          navigator.vibrate(200);
        }
      }

      // 更新掃描記錄列表
      function updateScannedList() {
        const listContainer = document.getElementById('scannedList');
        if (!listContainer) return;

        listContainer.innerHTML = '';
        
        if (scannedQRs.size === 0) {
          listContainer.innerHTML = '<p class="small">尚未掃描任何 QR 碼</p>';
          return;
        }

        const title = document.createElement('h4');
        title.textContent = `已掃描 ${scannedQRs.size} 個 QR 碼：`;
        listContainer.appendChild(title);

        scannedQRs.forEach((qr, index) => {
          const item = document.createElement('div');
          item.className = 'scanned-item';
          item.innerHTML = `
            <span class="qr-number">${index + 1}.</span>
            <span class="qr-content">${qr}</span>
            <button class="remove-btn" onclick="removeQR('${qr}')">×</button>
          `;
          listContainer.appendChild(item);
        });
      }

      // 移除 QR 碼
      function removeQR(qrText) {
        scannedQRs.delete(qrText);
        updateScannedList();
        
        // 如果移除的是當前 QR 內容，清空欄位
        if (document.getElementById('qrText').value === qrText) {
          document.getElementById('qrText').value = '';
        }
        
        setStatus(`已移除 QR 碼，剩餘 ${scannedQRs.size} 個`, 'info');
      }

      // 清空所有掃描記錄
      function clearAllQRs() {
        scannedQRs.clear();
        document.getElementById('qrText').value = '';
        updateScannedList();
        setStatus('已清空所有掃描記錄', 'info');
      }

      // 停止掃描
      function stopBarcodeScanner() {
        if (qrScanner) {
          qrScanner.stop();
          qrScanner.destroy();
          qrScanner = null;
        }
        
        // 啟用/停用按鈕
        document.getElementById('startScan').disabled = false;
        document.getElementById('stopScan').disabled = true;
        
        setStatus('QR 掃描器已停止', 'info');
      }

      // 手動輸入 QR 碼
      function manualQRInput() {
        const qrText = prompt('請輸入 QR 碼內容：');
        if (qrText && qrText.trim()) {
          const trimmedQR = qrText.trim();
          
          // 檢查是否已存在
          if (scannedQRs.has(trimmedQR)) {
            setStatus('此 QR 碼已存在於記錄中', 'warning');
            return;
          }
          
          // 添加到掃描記錄
          scannedQRs.add(trimmedQR);
          document.getElementById('qrText').value = trimmedQR;
          updateScannedList();
          setStatus(`QR 碼已手動輸入！已記錄 ${scannedQRs.size} 個 QR 碼`, 'success');
        }
      }

      // 綁定事件
      document.addEventListener('DOMContentLoaded', function() {
        const productSelect = document.getElementById('productName');
        const expiryInput = document.getElementById('expiryDate');
        const startScanBtn = document.getElementById('startScan');
        const stopScanBtn = document.getElementById('stopScan');
        
        if (productSelect) {
          productSelect.addEventListener('change', queryAutoBatch);
        }
        if (expiryInput) {
          expiryInput.addEventListener('change', queryAutoBatch);
        }
        if (startScanBtn) {
          startScanBtn.addEventListener('click', startBarcodeScanner);
        }
        if (stopScanBtn) {
          stopScanBtn.addEventListener('click', stopBarcodeScanner);
        }
        
        // 手動輸入 QR 碼按鈕
        const manualQRBtn = document.getElementById('manualQR');
        if (manualQRBtn) {
          manualQRBtn.addEventListener('click', manualQRInput);
        }
      });
    </script>
    <!-- 移除 ZXingBrowser，改用原生相機 API -->
  </body>
  </html>


